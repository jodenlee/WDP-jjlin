{% extends 'base.html' %}

{% block content %}
<section class="mb-5">
    <div class="mb-4">
        <a href="{{ url_for('main.home') }}" class="btn btn-primary btn-lg fs-4 py-2 px-4 shadow-sm">
            <i class="fas fa-home me-2"></i>{{ _('Return to Home') }}
        </a>
    </div>

    <!-- Header Actions -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
        <h1 class="fw-bold text-dark mb-3 mb-md-0">{{ _('Activities Feed') }}</h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('activities.create_activity') }}" class="btn btn-primary btn-lg">+ {{ _('New Activity')
                }}</a>
        </div>
    </div>

    {# --- read query params --- #}
    {% set q = request.args.get('q','') %}
    {% set loc_q = request.args.get('location','') %}
    {% set s = request.args.get('sort','newest') %}

    <!-- Search & Filters -->
    <div class="card border-0 shadow-sm p-3 mb-4 bg-light">
        <form action="{{ url_for('activities.activities_list') }}" method="get" class="row g-2 align-items-center"
            id="search-form">
            <!-- Search -->
            <div class="col-12 col-md-5 position-relative">
                <input type="text" name="q" id="search-input" class="form-control form-control-lg pe-5 search-bar-text"
                    placeholder="{{ _('Search activities...') }}" value="{{ q }}">
                <i class="fas fa-times position-absolute top-50 end-0 translate-middle-y me-4 text-muted cursor-pointer"
                    id="clear-search" style="cursor: pointer; display: none;"></i>
            </div>

            <!-- Sorting -->
            <div class="col-6 col-md-2">
                <select name="sort" class="form-select form-select-lg search-bar-text">
                    <option value="newest" {{ 'selected' if s=='newest' else '' }}>{{ _('Newest') }}</option>
                    <option value="upcoming" {{ 'selected' if s=='upcoming' else '' }}>{{ _('Upcoming') }}</option>
                    <option value="oldest" {{ 'selected' if s=='oldest' else '' }}>{{ _('Oldest') }}</option>
                </select>
            </div>

            <!-- Location -->
            <div class="col-6 col-md-4">
                <div class="input-group">
                    <input type="text" id="location-filter" name="location"
                        class="form-control form-control-lg search-bar-text" placeholder="{{ _('Location') }}"
                        value="{{ loc_q }}">
                    <button type="button" class="btn btn-outline-secondary border-start-0 border" id="clear-location"
                        style="display: none;" title="{{ _('Clear Location') }}">
                        <i class="fas fa-times"></i>
                    </button>
                    <button type="button" id="use-location-btn" class="btn btn-outline-secondary"
                        onclick="populateLocationField('location-filter', 'use-location-btn')"
                        title="{{ _('Use My Location') }}">
                        <i class="fas fa-crosshairs"></i>
                    </button>
                </div>
            </div>

            <!-- Search Button -->
            <div class="col-12 col-md-1 d-grid">
                <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-search"></i></button>
            </div>
        </form>
        <script src="{{ url_for('static', filename='js/geolocation.js') }}"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const searchInput = document.getElementById('search-input');
                const clearSearchBtn = document.getElementById('clear-search');
                const locationInput = document.getElementById('location-filter');
                const clearLocationBtn = document.getElementById('clear-location');

                function toggleClearButton(input, button) {
                    if (button) button.style.display = input.value.trim() !== '' ? 'block' : 'none';
                }

                if (searchInput) {
                    toggleClearButton(searchInput, clearSearchBtn);
                    searchInput.addEventListener('input', () => toggleClearButton(searchInput, clearSearchBtn));
                    clearSearchBtn.addEventListener('click', () => {
                        searchInput.value = '';
                        toggleClearButton(searchInput, clearSearchBtn);
                        searchInput.focus();
                    });
                }

                if (locationInput) {
                    toggleClearButton(locationInput, clearLocationBtn);
                    locationInput.addEventListener('input', () => toggleClearButton(locationInput, clearLocationBtn));
                    clearLocationBtn.addEventListener('click', () => {
                        locationInput.value = '';
                        toggleClearButton(locationInput, clearLocationBtn);
                        locationInput.focus();
                    });
                }
            });
        </script>
    </div>
</section>

<!-- Activities Grid -->
<div class="row g-4">
    {% if activities and activities|length > 0 %}
    {% for activity in activities %}

    {% set title = activity['title'] if activity['title'] else _('Untitled') %}
    {% set desc = activity['description'] if activity['description'] else '' %}
    {% set typ = activity['type'] if activity['type'] else _('Event') %}
    {% set date = activity['event_date'] %}
    {% set loc = activity['location'] %}
    {% set rsvp = activity['rsvp_count'] if activity['rsvp_count'] else 0 %}

    <div class="col-12 col-md-6 col-lg-4">
        <div class="card border-0 shadow-sm h-100 overflow-hidden">
            <!-- Card Header with gradient -->
            <div class="position-relative"
                style="height: 150px; background: linear-gradient(135deg, var(--primary-color) 0%, #21b3c9 100%);">
                <span
                    class="badge bg-white text-dark position-absolute top-0 end-0 m-3 px-3 py-2 rounded-pill fw-bold shadow-sm">
                    {{ typ|upper }}
                </span>
                <div class="position-absolute bottom-0 start-0 p-3 text-white">
                    {% if date %}
                    <div class="d-flex align-items-center gap-2 mb-1">
                        <i class="fas fa-calendar-alt"></i>
                        <span class="fw-bold">{{ date }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="fw-bold mb-0">{{ title }}</h5>

                    {% if 'user_id' in session and (activity['organizer_id']|int) == (session['user_id']|int) %}
                    <div class="dropdown">
                        <button class="btn btn-link btn-sm text-secondary p-0" type="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end border-0 shadow">
                            <li>
                                <a class="dropdown-item"
                                    href="{{ url_for('activities.edit_activity', activity_id=activity['id']) }}">
                                    <i class="fas fa-edit me-2 text-primary"></i> {{ _('Edit') }}
                                </a>
                            </li>
                            <li>
                                <form action="{{ url_for('activities.delete_activity', activity_id=activity['id']) }}"
                                    method="POST"
                                    onsubmit="return confirm('Delete this activity? This cannot be undone.');">
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i class="fas fa-trash-alt me-2"></i> {{ _('Delete') }}
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                    {% endif %}
                </div>

                <p class="text-muted mb-3" style="min-height: 48px;">
                    {% if desc %}
                    {{ desc[:100] }}{% if desc|length > 100 %}...{% endif %}
                    {% else %}
                    <span class="fst-italic">{{ _('No description provided.') }}</span>
                    {% endif %}
                </p>

                <div class="d-flex justify-content-between align-items-center text-muted small mb-3">
                    <div class="d-flex align-items-center gap-1">
                        <i class="fas fa-users text-primary"></i>
                        <span>{{ rsvp }} {{ _('attending') }}</span>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                        <i class="fas fa-map-marker-alt text-danger"></i>
                        <span>{{ loc if loc else 'TBA' }}</span>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <a href="{{ url_for('activities.view_activity', activity_id=activity['id']) }}"
                        class="btn btn-outline-primary flex-grow-1">
                        {{ _('View Details') }}
                    </a>
                    {% if activity['id'] in user_joined_ids %}
                    <form action="{{ url_for('activities.leave_activity', activity_id=activity['id']) }}" method="POST">
                        <button class="btn btn-success" type="submit" title="Click to leave">
                            <i class="fas fa-check me-1"></i> {{ _('Joined') }}
                        </button>
                    </form>
                    {% else %}
                    <form action="{{ url_for('activities.join_activity', activity_id=activity['id']) }}" method="POST">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-check me-1"></i> {{ _('Join') }}
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% endfor %}
    {% else %}
    <div class="col-12">
        <div class="text-center py-5">
            <div class="mb-3" style="font-size: 64px; opacity: 0.3;">ðŸ“…</div>
            <h3 class="fw-bold mb-2">{{ _('No activities yet') }}</h3>
            <p class="text-muted mb-4">{{ _('Create the first activity and invite others to join!') }}</p>
            <a href="{{ url_for('activities.create_activity') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-plus me-2"></i> {{ _('Create Activity') }}
            </a>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}