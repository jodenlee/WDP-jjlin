{% extends 'base.html' %}

{% block content %}
<!-- Back to group buttons -->
<div class="mb-4">
    <a href="{{ url_for('community.community') }}" class="btn btn-link text-muted px-0">
        <i class="fas fa-arrow-left me-1"></i> Back to Groups
    </a>
</div>

<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card nav-card-minimal">
            <div class="card-body p-0 position-relative">
                <!-- Action Buttons: Positioned absolutely at the top-right -->
                <div class="position-absolute top-0 end-0 m-4 d-flex flex-column gap-2">
                    {% if is_owner %}
                    <!-- Owner Action: Update Group -->
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                        data-bs-target="#updateGroupModal">
                        <i class="fas fa-edit me-1"></i> {{ _('Update Group') }}
                    </button>
                    <!-- Owner Action: Delete Group -->
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                        data-bs-target="#deleteGroupModal">
                        <i class="fas fa-trash-alt me-1"></i> {{ _('Delete Group') }}
                    </button>
                    {% else %}
                    {% if is_member %}
                    <!-- Member Action: Leave Group -->
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                        data-bs-target="#leaveGroupModal">
                        <i class="fas fa-sign-out-alt me-1"></i> {{ _('Leave Group') }}
                    </button>
                    {% elif session.get('user_id') %}
                    <!-- Non-Member Action: Join Group -->
                    <form action="{{ url_for('community.join_group', group_id=group['id']) }}" method="POST"
                        class="d-inline">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-sign-in-alt me-1"></i> {{ _('Join Group') }}
                        </button>
                    </form>
                    {% endif %}
                    {% endif %}

                    {% if session.get('user_id') and not is_owner %}
                    <!-- User Action: Report Group -->
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                        data-bs-target="#reportGroupModal">
                        <i class="fas fa-flag me-1"></i> {{ _('Report Group') }}
                    </button>
                    {% endif %}
                </div>

                <div class="p-4 p-md-5"> <!-- Inner padding container -->
                    <!-- Group Information Section -->
                    <div class="text-center mb-4">
                        {% if group['image_url'] %}
                        <!-- Group Image -->
                        <img src="{{ url_for('static', filename=group['image_url']) }}" class="rounded-circle mb-3"
                            style="width: 100px; height: 100px; object-fit: cover;">
                        {% else %}
                        <!-- Placeholder Image if none exists -->
                        <div class="rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center"
                            style="width: 100px; height: 100px; background-color: var(--accent-color);">
                            <i class="fas fa-users fa-3x" style="color: var(--primary-color);"></i>
                        </div>
                        {% endif %}
                        <!--Show group name-->
                        <h2 class="fw-bold">{{ group['name'] }}</h2>
                        <!--Show member count-->
                        <p class="text-muted"><i class="fas fa-user-friends me-1"></i> {{ member_count }} members</p>
                    </div>

                    <!-- Group Description -->
                    <div class="mb-4">
                        <h5 class="fw-bold">About</h5>
                        <p class="text-muted">{{ group['description'] or 'No description provided.' }}</p>
                    </div>

                    <!-- Members List Section -->
                    <div>
                        <h5 class="fw-bold mb-3">Members</h5>
                        {% if members %}
                        <div class="list-group list-group-flush">
                            {% for member in members %}
                            <div class="list-group-item bg-transparent px-0 d-flex align-items-center">
                                <!-- Member Avatar -->
                                <div class="rounded-circle me-3 d-flex align-items-center justify-content-center"
                                    style="width: 40px; height: 40px; background-color: var(--accent-color);">
                                    <i class="fas fa-user" style="color: var(--primary-color);"></i>
                                </div>
                                <!-- Member Details -->
                                <div>
                                    <span class="fw-bold">{{ member['username'] }}</span>
                                    <span class="badge bg-light text-dark ms-2"> {{ member['role']|capitalize }} </span>
                                    {% if group['created_by'] == member['id'] %}
                                    <span style="color: green; font-weight: bold;"> Creator</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <!-- Empty State for Members -->
                        <p class="text-muted">No members yet.</p>
                        {% endif %}
                    </div>

                    <hr class="my-4">

                    <!-- Community Posts Section -->
                    <div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold mb-0">Community Posts</h5>
                            {% if is_owner or is_member %}
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#createPostModal">
                                <i class="fas fa-pen me-1"></i> Post
                            </button>
                            {% endif %}
                        </div>

                        {% if posts %}
                        {% for post in posts %}
                        <div class="card mb-3 border-0 bg-light" id="post-{{ post['id'] }}">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                    <img src="{{ post['profile_pic'] or 'https://ui-avatars.com/api/?name=' + post['username'] }}"
                                        class="rounded-circle me-2"
                                        style="width: 40px; height: 40px; object-fit: cover;">
                                    <div>
                                        <h6 class="fw-bold mb-0">{{ post['username'] }}</h6>
                                        <small class="text-muted">{{ post['created_at']|to_sgt }}</small>
                                    </div>
                                    <!-- Like Button -->
                                    <div class="ms-auto d-flex align-items-center">
                                        <form
                                            action="{{ url_for('community.toggle_group_post_like', post_id=post['id']) }}"
                                            method="POST" class="d-inline">
                                            <button type="submit"
                                                class="btn btn-link p-0 text-decoration-none {% if post['is_liked'] %}text-danger{% else %}text-muted{% endif %}"
                                                title="Like">
                                                <i
                                                    class="{% if post['is_liked'] %}fas{% else %}far{% endif %} fa-heart fa-lg"></i>
                                            </button>
                                        </form>
                                        <span class="ms-1 text-muted small">{{ post['likes'] }}</span>
                                    </div>
                                    <!-- More Options Dropdown -->
                                    <div class="dropdown ms-3">
                                        <button class="btn btn-link text-muted p-0" type="button"
                                            data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item small py-1" href="#"
                                                    onclick="toggleEnlarge(event, 'post-{{ post.id }}', this)">
                                                    <i class="fas fa-expand-alt me-2"></i> Enlarge Post
                                                </a></li>
                                            {% if post['user_id'] == session['user_id'] %}
                                            <li>
                                                <a class="dropdown-item small py-1 text-primary" href="#"
                                                    data-update-url="{{ url_for('community.update_group_post', post_id=post['id']) }}"
                                                    data-post-content="{{ post['content'] }}"
                                                    onclick="openEditPostModal(this)">
                                                    <i class="fas fa-edit me-2"></i> Edit Post
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item small py-1 text-danger" href="#"
                                                    data-delete-url="{{ url_for('community.delete_group_post', post_id=post['id']) }}"
                                                    onclick="openDeletePostModal(this)">
                                                    <i class="fas fa-trash-alt me-2"></i> Delete Post
                                                </a>
                                            </li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </div>
                                <p class="card-text" id="postContent-{{ post['id'] }}">{{ post['content'] }}</p>
                                <!-- Read Aloud Button -->
                                <button type="button" class="btn btn-sm btn-outline-secondary mb-2"
                                    onclick="readAloud('postContent-{{ post.id }}', this)">
                                    <i class="fas fa-volume-up"></i> Read Aloud
                                </button>
                                {% if post['image_url'] %}
                                <img src="{{ url_for('static', filename=post['image_url']) }}"
                                    class="img-fluid rounded mb-3">
                                {% endif %}

                                {% if post['audio_url'] %}
                                <div class="mb-3">
                                    <audio controls class="w-100">
                                        <source src="{{ url_for('static', filename=post['audio_url']) }}">
                                        Your browser does not support the audio element.
                                    </audio>
                                </div>
                                {% endif %}

                                <!-- Comments Section -->
                                <div class="mt-3">
                                    {% if post['comments'] %}
                                    <div class="ps-3 border-start mb-2">
                                        {% for comment in post['comments'] %}
                                        <div class="mb-2 d-flex justify-content-between align-items-start">
                                            <div>
                                                <strong>{{ comment['username'] }}:</strong> {{ comment['content'] }}
                                            </div>
                                            {% if comment['user_id'] == session['user_id'] %}
                                            <div class="dropdown">
                                                <button class="btn btn-link text-muted p-0" type="button"
                                                    data-bs-toggle="dropdown" aria-expanded="false"
                                                    style="font-size: 0.8rem;">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end">
                                                    <li>
                                                        <a class="dropdown-item small py-1 text-primary" href="#"
                                                            data-update-url="{{ url_for('community.update_group_post_comment', comment_id=comment['id']) }}"
                                                            data-comment-content="{{ comment['content'] }}"
                                                            onclick="openEditCommentModal(this)">
                                                            <i class="fas fa-edit me-2"></i> Edit Comment
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item small py-1 text-danger" href="#"
                                                            data-delete-url="{{ url_for('community.delete_group_post_comment', comment_id=comment['id']) }}"
                                                            onclick="openDeleteCommentModal(this)">
                                                            <i class="fas fa-trash-alt me-2"></i> Delete Comment
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}

                                    <!-- Add Comment Form -->
                                    <form
                                        action="{{ url_for('community.create_group_post_comment', post_id=post['id']) }}"
                                        method="POST" class="d-flex gap-2">
                                        <input type="text" name="content" class="form-control form-control-sm"
                                            placeholder="Write a comment..." required>
                                        <button type="submit" class="btn btn-sm btn-outline-secondary">Send</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-muted text-center py-4 bg-light rounded">No posts yet. Be the first to share
                            something!</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Delete Group Modal -->
    <div class="modal fade" id="deleteGroupModal" tabindex="-1" aria-labelledby="deleteGroupModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteGroupModalLabel">Confirm delete?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this group? This action cannot be undone and all members will be
                        removed.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form action="{{ url_for('community.delete_group', group_id=group['id']) }}" method="POST">
                        <button type="submit" class="btn btn-danger">Delete Group</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave Group Modal -->
    <div class="modal fade" id="leaveGroupModal" tabindex="-1" aria-labelledby="leaveGroupModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="leaveGroupModalLabel">Confirm leave?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to leave this group?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form action="{{ url_for('community.leave_group', group_id=group['id']) }}" method="POST">
                        <button type="submit" class="btn btn-danger">Leave Group</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Group Edit Modal -->
    <div class="modal fade" id="updateGroupModal" tabindex="-1" aria-labelledby="updateGroupModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateGroupModalLabel">Update Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="updateGroupForm" action="{{ url_for('community.update_group', group_id=group['id']) }}"
                        method="POST" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="name" class="form-label fw-bold">Group Name</label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ group['name'] }}"
                                required minlength="5"
                                oninvalid="if(this.value.length > 0 && this.value.length < 5) this.setCustomValidity('Have at least 5 characters'); else this.setCustomValidity('');"
                                oninput="this.setCustomValidity('');">
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label fw-bold">Description</label>
                            <textarea class="form-control" id="description" name="description"
                                rows="4">{{ group['description'] }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label for="image" class="form-label fw-bold">Group Image (optional)</label>
                            <input type="file" class="form-control" id="image" name="image" accept="image/*">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <!-- Trigger Validation via JS -->
                    <button type="button" class="btn btn-primary" onclick="validateAndUpdate()">Update Group</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Update Modal -->
    <div class="modal fade" id="confirmUpdateModal" tabindex="-1" aria-labelledby="confirmUpdateModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmUpdateModalLabel">Confirm update group?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to update the group details?</p>
                </div>
                <div class="modal-footer">
                    <!-- Back to Edit Modal -->
                    <button type="button" class="btn btn-secondary" data-bs-toggle="modal"
                        data-bs-target="#updateGroupModal" data-bs-dismiss="modal">Cancel</button>
                    <!-- Actual Submit (Remote Submit using JS) -->
                    <button type="button" class="btn btn-primary"
                        onclick="document.getElementById('updateGroupForm').submit();">Confirm Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div class="modal fade" id="createPostModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Post</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createPostForm"
                        action="{{ url_for('community.create_group_post', group_id=group['id']) }}" method="POST"
                        enctype="multipart/form-data">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label fw-bold mb-0">Post Content</label>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="dictateButton">
                                    <i class="fas fa-microphone-alt"></i> Dictate
                                </button>
                            </div>
                            <textarea class="form-control" name="content" id="postContent" rows="4"
                                placeholder="Share your day..."></textarea>
                            <small id="dictateStatus" class="text-primary d-none"><i
                                    class="fas fa-circle text-danger blink"></i> Listening...</small>
                        </div>

                        <!-- Voice Recording Section -->
                        <div class="mb-3">
                            <label class="form-label fw-bold d-block">Voice Message</label>

                            <div id="recordingControls" class="d-flex gap-2 align-items-center mb-2">
                                <button type="button" class="btn btn-outline-danger" id="recordButton">
                                    <i class="fas fa-microphone"></i> Record
                                </button>
                                <button type="button" class="btn btn-danger d-none" id="stopButton">
                                    <i class="fas fa-stop"></i> Stop
                                </button>
                                <span id="recordingStatus" class="text-danger fw-bold d-none">Recording... <span
                                        id="timer">00:00</span></span>
                            </div>

                            <div id="audioPreviewContainer" class="d-none">
                                <audio id="audioPreview" controls class="w-100 mb-2"></audio>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="retryButton">
                                    <i class="fas fa-redo"></i> Retry Recording
                                </button>
                            </div>

                            <!-- Hidden input to store audio blob data is handled via JS FormData, so no input needed here but we need the name 'audio' in JS -->
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="createPostForm" id="submitPostButton"
                        class="btn btn-primary">Post</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function validateAndUpdate() {
            var form = document.getElementById('updateGroupForm');
            if (form.checkValidity()) {
                // Hide edit modal
                var updateModalEl = document.getElementById('updateGroupModal');
                var updateModal = bootstrap.Modal.getInstance(updateModalEl);
                updateModal.hide();

                // Show confirmation modal
                var confirmModal = new bootstrap.Modal(document.getElementById('confirmUpdateModal'));
                confirmModal.show();
            } else {
                form.reportValidity();
            }
        }

        function toggleEnlarge(event, postId, btnElement) {
            event.preventDefault(); // Prevent default anchor behavior
            var postCard = document.getElementById(postId);
            postCard.classList.toggle('enlarged-post');

            if (postCard.classList.contains('enlarged-post')) {
                btnElement.innerHTML = '<i class="fas fa-compress-alt me-2"></i> Shrink Post';
            } else {
                btnElement.innerHTML = '<i class="fas fa-expand-alt me-2"></i> Enlarge Post';
            }
        }

        // Voice Recording Logic
        document.addEventListener('DOMContentLoaded', function () {
            const recordButton = document.getElementById('recordButton');
            const stopButton = document.getElementById('stopButton');
            const retryButton = document.getElementById('retryButton');
            const audioPreview = document.getElementById('audioPreview');
            const audioPreviewContainer = document.getElementById('audioPreviewContainer');
            const recordingControls = document.getElementById('recordingControls');
            const recordingStatus = document.getElementById('recordingStatus');
            const timerDisplay = document.getElementById('timer');
            const createPostForm = document.getElementById('createPostForm');
            const postContent = document.getElementById('postContent');
            const submitPostButton = document.getElementById('submitPostButton');

            let mediaRecorder;
            let audioChunks = [];
            let audioBlob = null;
            let startTime;
            let timerInterval;

            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // Permissions and setup handled on click to avoid annoying popups on page load
            } else {
                recordButton.disabled = true;
                recordButton.innerText = "Audio not supported";
            }

            recordButton.addEventListener('click', async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        audioBlob = new Blob(audioChunks, { type: 'audio/wav' }); // or 'audio/mp3' if supported but wav is safer
                        const audioUrl = URL.createObjectURL(audioBlob);
                        audioPreview.src = audioUrl;

                        audioChunks = [];

                        // UI Updates
                        recordingControls.classList.add('d-none');
                        audioPreviewContainer.classList.remove('d-none');
                        stopTimer();

                        if (submitPostButton) submitPostButton.disabled = false;
                    };

                    mediaRecorder.start();
                    if (submitPostButton) submitPostButton.disabled = true;

                    // UI Updates
                    recordButton.classList.add('d-none');
                    stopButton.classList.remove('d-none');
                    recordingStatus.classList.remove('d-none');
                    startTimer();

                } catch (err) {
                    console.error("Error accessing microphone:", err);
                    alert("Could not access microphone. Please ensure you have granted permission.");
                }
            });

            stopButton.addEventListener('click', () => {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                    mediaRecorder.stream.getTracks().forEach(track => track.stop()); // Stop stream
                }
            });

            retryButton.addEventListener('click', () => {
                audioBlob = null;
                audioPreview.src = '';

                audioPreviewContainer.classList.add('d-none');
                recordingControls.classList.remove('d-none');
                recordButton.classList.remove('d-none');
                stopButton.classList.add('d-none');
                recordingStatus.classList.add('d-none');
                timerDisplay.innerText = "00:00";
            });

            // Form Submission Interception
            createPostForm.addEventListener('submit', function (event) {

                // Validation: Must have text OR audio
                if (!postContent.value.trim() && !audioBlob) {
                    event.preventDefault();
                    alert("Please enter text or record a voice message.");
                    return;
                }

                if (audioBlob) {
                    event.preventDefault();
                    const formData = new FormData(createPostForm);
                    formData.append('audio', audioBlob, 'recording.wav');

                    if (submitPostButton) {
                        submitPostButton.disabled = true;
                        submitPostButton.innerText = "Posting...";
                    }

                    fetch(createPostForm.action, {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => {
                            if (response.redirected) {
                                window.location.href = response.url;
                            } else {
                                // Fallback if not redirected (e.g. error), reload or handle
                                window.location.reload();
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert("An error occurred while posting: " + error.message);
                            if (submitPostButton) {
                                submitPostButton.disabled = false;
                                submitPostButton.innerText = "Post";
                            }
                        });
                }
                // If no audio, let the form submit normally
            });

            function startTimer() {
                startTime = Date.now();
                timerInterval = setInterval(() => {
                    const elapsedTime = Date.now() - startTime;
                    const seconds = Math.floor((elapsedTime / 1000) % 60);
                    const minutes = Math.floor((elapsedTime / 1000 / 60));
                    timerDisplay.innerText = `${pad(minutes)}:${pad(seconds)}`;
                }, 1000);
            }

            function stopTimer() {
                clearInterval(timerInterval);
            }

            function pad(number) {
                return number.toString().padStart(2, '0');
            }
        });

        // Speech-to-Text (Dictation) Logic
        const dictateButton = document.getElementById('dictateButton');
        const dictateStatus = document.getElementById('dictateStatus');
        const postContentTextarea = document.getElementById('postContent');

        let recognition = null;
        let isListening = false;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = function (event) {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    }
                }
                if (finalTranscript) {
                    postContentTextarea.value += finalTranscript + ' ';
                }
            };

            recognition.onerror = function (event) {
                console.error('Speech recognition error:', event.error);
                stopDictation();
                alert('Speech recognition error: ' + event.error);
            };

            recognition.onend = function () {
                if (isListening) {
                    recognition.start(); // Restart if still listening
                }
            };

            if (dictateButton) {
                dictateButton.addEventListener('click', function () {
                    if (isListening) {
                        stopDictation();
                    } else {
                        startDictation();
                    }
                });
            }
        } else {
            if (dictateButton) {
                dictateButton.disabled = true;
                dictateButton.innerHTML = '<i class="fas fa-microphone-alt-slash"></i> Not Supported';
            }
        }

        function startDictation() {
            if (recognition) {
                isListening = true;
                recognition.start();
                dictateButton.innerHTML = '<i class="fas fa-stop"></i> Stop Dictation';
                dictateButton.classList.remove('btn-outline-primary');
                dictateButton.classList.add('btn-danger');
                dictateStatus.classList.remove('d-none');
            }
        }

        function stopDictation() {
            if (recognition) {
                isListening = false;
                recognition.stop();
                dictateButton.innerHTML = '<i class="fas fa-microphone-alt"></i> Dictate';
                dictateButton.classList.remove('btn-danger');
                dictateButton.classList.add('btn-outline-primary');
                dictateStatus.classList.add('d-none');
            }
        }

        // Text-to-Speech (Read Aloud) Logic - Global function
        window.readAloud = function (elementId, buttonElement) {
            const textElement = document.getElementById(elementId);
            if (!textElement) return;

            const text = textElement.innerText;

            if ('speechSynthesis' in window) {
                // Stop any ongoing speech
                if (window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                    buttonElement.innerHTML = '<i class="fas fa-volume-up"></i> Read Aloud';
                    return;
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;

                utterance.onstart = function () {
                    buttonElement.innerHTML = '<i class="fas fa-stop"></i> Stop';
                };

                utterance.onend = function () {
                    buttonElement.innerHTML = '<i class="fas fa-volume-up"></i> Read Aloud';
                };

                utterance.onerror = function () {
                    buttonElement.innerHTML = '<i class="fas fa-volume-up"></i> Read Aloud';
                };

                window.speechSynthesis.speak(utterance);
            } else {
                alert('Text-to-speech is not supported in your browser.');
            }
        };

    </script>

    <style>
        .blink {
            animation: blinker 1s linear infinite;
        }

        @keyframes blinker {
            50% {
                opacity: 0;
            }
        }
    </style>

    <!-- Edit Post Modal -->
    <div class="modal fade" id="editPostModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Post</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editPostForm" method="POST">
                        <div class="mb-3">
                            <textarea class="form-control" id="editPostContent" name="content" rows="4"
                                required></textarea>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Post Modal -->
    <div class="modal fade" id="deletePostModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete Post?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this post?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form id="deletePostForm" method="POST">
                        <button type="submit" class="btn btn-danger">Delete Post</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openEditPostModal(element) {
            var url = element.getAttribute('data-update-url');
            var content = element.getAttribute('data-post-content');

            document.getElementById('editPostForm').action = url;
            document.getElementById('editPostContent').value = content;

            var modal = new bootstrap.Modal(document.getElementById('editPostModal'));
            modal.show();
        }

        function openDeletePostModal(element) {
            var url = element.getAttribute('data-delete-url');
            document.getElementById('deletePostForm').action = url;

            var modal = new bootstrap.Modal(document.getElementById('deletePostModal'));
            modal.show();
        }

        function openEditCommentModal(element) {
            var url = element.getAttribute('data-update-url');
            var content = element.getAttribute('data-comment-content');

            document.getElementById('editCommentForm').action = url;
            document.getElementById('editCommentContent').value = content;

            var modal = new bootstrap.Modal(document.getElementById('editCommentModal'));
            modal.show();
        }

        function openDeleteCommentModal(element) {
            var url = element.getAttribute('data-delete-url');
            document.getElementById('deleteCommentForm').action = url;

            var modal = new bootstrap.Modal(document.getElementById('deleteCommentModal'));
            modal.show();
        }
    </script>

    <!-- Edit Comment Modal -->
    <div class="modal fade" id="editCommentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Comment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCommentForm" method="POST">
                        <div class="mb-3">
                            <textarea class="form-control" id="editCommentContent" name="content" rows="3"
                                required></textarea>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Comment Modal -->
    <div class="modal fade" id="deleteCommentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete Comment?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this comment?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form id="deleteCommentForm" method="POST">
                        <button type="submit" class="btn btn-danger">Delete Comment</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Report Group Modal -->
    <div class="modal fade" id="reportGroupModal" tabindex="-1" aria-labelledby="reportGroupModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-bottom-0 pb-0">
                    <h5 class="modal-title fw-bold text-dark fs-4" id="reportGroupModalLabel">{{ _('Report Group') }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('community.report_group', group_id=group['id']) }}" method="POST">
                    <div class="modal-body text-secondary fs-5 py-3">
                        <p class="mb-2">{{ _('Why are you reporting this group?') }}</p>
                        <textarea name="reason" class="form-control" rows="4"
                            placeholder="{{ _('Please describe the issue...') }}" required></textarea>
                    </div>
                    <div class="modal-footer border-top-0 pt-0 pb-4 justify-content-center">
                        <button type="button" class="btn btn-secondary px-4 fw-bold" data-bs-dismiss="modal">{{
                            _('Cancel')
                            }}</button>
                        <button type="submit" class="btn btn-danger px-4 fw-bold">{{ _('Submit Report') }}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% endblock %}