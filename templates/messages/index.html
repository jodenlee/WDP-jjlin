{% extends 'base.html' %}

{% block main_class %}container-fluid p-0{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat-telegram.css') }}">
<!-- WhatsApp iOS Style Home Screen Overlay -->


<style>
    /* Ensure body allows scrolling for footer */
    body {
        overflow-x: hidden;
        /* Prevent horizontal scroll interactions */
    }

    /* Selection Checkbox Styles */
    .whatsapp-select-checkbox {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        border: 2px solid #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        flex-shrink: 0;
        display: none;
        /* Hidden by default */
    }

    .whatsapp-list-row.selection-mode .whatsapp-select-checkbox {
        display: flex;
    }

    /* Selected State - Gold/Brown */
    .whatsapp-list-row.selected .whatsapp-select-checkbox {
        background: var(--accent-color) !important;
        border-color: var(--accent-color) !important;
    }
</style>
<div class="whatsapp-home-container">

    <!-- Sticky Header -->
    <div class="whatsapp-home-header">
        <!-- Top Controls -->
        <div class="whatsapp-top-controls">
            <div style="position: relative;">
                <button class="whatsapp-control-btn circle-icon" onclick="toggleDropdown('moreOptionsDropdown')"
                    style="font-size: 0.9rem; width: 30px; height: 30px; background: rgba(166,138,100,0.15); color: var(--accent-color); font-weight: 600;">
                    <i class="fas fa-ellipsis-h"></i>
                </button>
                <!-- More Options Dropdown -->
                <div id="moreOptionsDropdown" class="whatsapp-dropdown-menu" style="left: 0; right: auto;">
                    <div class="whatsapp-dropdown-item" onclick="enterSelectionMode()">
                        <i class="fas fa-check-circle"></i> Select chats
                    </div>
                    <div class="whatsapp-dropdown-item" onclick="markAllAsRead()">
                        <i class="fas fa-check-double"></i> Read all
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; position: relative;">
                <button class="whatsapp-control-btn circle-icon" onclick="toggleDropdown('newChatDropdown')"
                    style="background: #25D366; color: white;">
                    <i class="fas fa-plus"></i>
                </button>
                <!-- New Chat Dropdown -->
                <div id="newChatDropdown" class="whatsapp-dropdown-menu">
                    <div class="whatsapp-dropdown-item" onclick="openNewGroupModal()">
                        <i class="fas fa-users"></i> New group
                    </div>
                    <div class="whatsapp-dropdown-item" onclick="openNewChatModal()">
                        <i class="fas fa-user-plus"></i> New chat
                    </div>
                </div>
            </div>
        </div>

        <!-- Title -->
        <h1 class="whatsapp-page-title">Chats</h1>

        <!-- Search -->
        <div class="whatsapp-search-wrapper">
            <i class="fas fa-search whatsapp-search-icon"></i>
            <input type="text" class="whatsapp-search-input" placeholder="Ask Meta AI or Search"
                onkeyup="filterChatsDebounced()">
        </div>

        <!-- Filters -->
        <div class="whatsapp-filters">
            <button class="whatsapp-filter-chip active" onclick="setFilter('all', this)">All</button>
            <button class="whatsapp-filter-chip" onclick="setFilter('unread', this)">Unread <span
                    style="background: rgba(166,138,100,0.2); border-radius: 50%; padding: 0 5px; font-size: 0.75rem; margin-left: 4px;">{{
                    conversations|selectattr('unread_count', 'gt', 0)|list|length }}</span></button>
            <button class="whatsapp-filter-chip" onclick="setFilter('groups', this)">Groups</button>
        </div>
    </div>

    <!-- Chat List -->
    <div class="whatsapp-chat-list" id="chatList">

        <a href="{{ url_for('messages.archived_chats_view') }}"
            style="text-decoration: none; color: inherit; display: block;">
            <div class="whatsapp-archive-row">
                <div class="whatsapp-archive-icon"><i class="fas fa-archive"></i></div>
                <div style="flex: 1;">Archived</div>
                <div style="color: var(--accent-color);">{{ archived_count }}</div>
            </div>
        </a>
        <div style="height: 1px; background: #c6c6c8; transform: scaleY(0.5); opacity: 0.5; margin-left: 16px;"></div>

        <div id="conversationsContainer">
            {% if conversations %}
            {% for convo in conversations %}
            <div class="whatsapp-list-row" data-user-id="{{ convo['user_id'] }}"
                data-unread="{{ convo['unread_count'] }}" data-type="{{ convo.get('type', 'private') }}"
                data-timestamp="{{ convo.get('timestamp', 0) }}"
                data-pinned="{{ 'true' if convo.get('is_pinned') else 'false' }}"
                data-href="{% if convo.get('type') == 'group' %}{{ url_for('messages.group_chat', group_id=convo['user_id']) }}{% else %}{{ url_for('messages.chat', user_id=convo['user_id']) }}{% endif %}"
                onclick="handleRowClick(this, this.dataset.href)">
                <!-- Selection Checkbox -->
                <div class="whatsapp-select-checkbox">
                    <i class="fas fa-check" style="color: white; font-size: 0.8rem;"></i>
                </div>

                <!-- Avatar -->
                <img src="https://ui-avatars.com/api/?name={{ convo['username'] }}&background=A68A64&color=1c1c1e&bold=true"
                    class="whatsapp-list-avatar" alt="{{ convo['username'] }}">

                <!-- Content -->
                <div class="whatsapp-list-content">
                    <div class="whatsapp-list-header">
                        <div class="whatsapp-list-name">
                            {{ convo['username'] }}
                        </div>
                        <div class="whatsapp-list-time {{ 'active' if convo['unread_count'] > 0 else '' }}">
                            {{ convo['last_message_time'] }}
                        </div>
                    </div>

                    <div class="whatsapp-list-preview-row">
                        <div class="whatsapp-list-msg">
                            <!-- Read Receipt Logic -->
                            {% if convo['last_message_sender_id'] == session['user_id'] %}
                            {% if convo['last_message_is_read'] %}
                            <i class="fas fa-check-double read-receipt-icon"
                                style="color: #34b7f1; margin-right: 4px;"></i>
                            <!-- Blue ticks -->
                            {% else %}
                            <i class="fas fa-check-double read-receipt-icon"
                                style="color: grey; margin-right: 4px;"></i>
                            <!-- Grey ticks -->
                            {% endif %}
                            {% endif %}

                            {% if convo['last_message'] and convo['last_message'].startswith('LOCATION:') %}
                            <i class="fas fa-map-marker-alt"></i> Location
                            {% elif convo['last_message'] and convo['last_message'].startswith('VOICE:') %}
                            <i class="fas fa-microphone"></i> Voice message
                            {% elif convo['last_message'] %}
                            {{ convo['last_message'] }}
                            {% else %}
                            <span style="color: #999;">No messages yet</span>
                            {% endif %}
                        </div>

                        <!-- Meta: Muted, Pinned, Unread -->
                        <div class="whatsapp-list-meta">
                            {% if convo['is_muted'] %}
                            <i class="fas fa-bell-slash whatsapp-muted-icon"></i>
                            {% endif %}

                            {% if convo.get('is_pinned') %}
                            <i class="fas fa-thumbtack whatsapp-pinned-icon"></i>
                            {% endif %}

                            {% if convo['unread_count'] > 0 %}
                            <div class="whatsapp-unread-badge">{{ convo['unread_count'] }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-5">
                <p class="text-muted">No chats yet.</p>
            </div>
            {% endif %}
        </div>

        <!-- Padding for bottom nav -->
        <div style="height: 80px;"></div>
    </div>

    <!-- Custom Delete Modal -->
    <div id="deleteModal" class="whatsapp-modal-overlay">
        <div class="whatsapp-modal-content">
            <div class="whatsapp-modal-icon">
                <i class="fas fa-times"></i>
            </div>
            <h3 class="whatsapp-modal-title">Delete chat</h3>
            <p class="whatsapp-modal-text">Are you sure you want to delete the selected chat(s)?</p>
            <div class="whatsapp-modal-checkbox-wrapper">
                <input type="checkbox" id="deleteForEveryone" class="whatsapp-modal-checkbox">
                <label for="deleteForEveryone">Also delete for others</label>
            </div>
            <div class="whatsapp-modal-actions">
                <button class="whatsapp-modal-btn cancel" onclick="closeDeleteModal()">CANCEL</button>
                <button class="whatsapp-modal-btn delete" onclick="confirmDeleteChats()">DELETE CHAT</button>
            </div>
        </div>
    </div>

    <!-- Batch Actions Bar (For Select Chats) -->
    <div class="batch-actions-bar" id="listBatchBar" style="display: none;">
        <div class="batch-actions-left">
            <button class="batch-cancel-btn" onclick="exitSelectionMode()">✕</button>
            <span class="batch-count" id="listSelectedCount">0 selected</span>
        </div>
        <div class="batch-actions-right">
            <!-- Could add more functions here, just Delete/Read for now if needed. 
                  User "Select chats logic working the same... but read all would mean..." 
                  Actually the request implies "Read all" is a separate button in the dropdown, not necessarily a batch action.
                  The batch action usually allows "Delete" or "Archive".
                  I'll add "Delete" to match the batch bar.
             -->
            <button class="batch-action-btn delete" onclick="deleteSelectedChats()">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="whatsapp-bottom-nav">
        <a href="{{ url_for('messages.calls_list') }}" class="whatsapp-nav-item">
            <div class="whatsapp-nav-icon"><i class="fas fa-phone-alt"></i></div>
            <span class="whatsapp-nav-label">Calls</span>
        </a>

        <a href="{{ url_for('messages.messages_list') }}" class="whatsapp-nav-item active">
            <div class="whatsapp-nav-icon">
                <i class="fas fa-comment-alt"></i>
                {% set total_unread = conversations|sum(attribute='unread_count') %}
                {% if total_unread > 0 %}
                <div class="whatsapp-nav-badge">{{ total_unread }}</div>
                {% endif %}
            </div>
            <span class="whatsapp-nav-label">Chats</span>
        </a>
    </div>
</div>

<!-- New Chat Modal -->
<div id="newChatModal" class="whatsapp-modal-overlay">
    <div class="whatsapp-modal-content"
        style="max-width: 400px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
        <div
            style="display: flex; align-items: center; justify-content: space-between; padding-bottom: 15px; border-bottom: 1px solid #eee;">
            <h3 style="margin: 0; color: #333;">New chat</h3>
            <button onclick="closeNewChatModal()"
                style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">✕</button>
        </div>
        <div style="padding: 10px 0;">
            <input type="text" id="newChatSearch" placeholder="Search users..." oninput="filterNewChatUsers()"
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem;">
        </div>
        <div id="newChatUserList" style="flex: 1; overflow-y: auto; max-height: 400px;"></div>
    </div>
</div>

<!-- New Group Modal -->
<div id="newGroupModal" class="whatsapp-modal-overlay">
    <div class="whatsapp-modal-content"
        style="max-width: 400px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column;">
        <!-- Step 1: User Selection -->
        <div id="groupStep1">
            <div
                style="display: flex; align-items: center; justify-content: space-between; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                <h3 style="margin: 0; color: #333;">Add members</h3>
                <button onclick="closeNewGroupModal()"
                    style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">✕</button>
            </div>
            <div style="padding: 10px 0;">
                <input type="text" id="groupUserSearch" placeholder="Search users..." oninput="filterGroupUsers()"
                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem;">
            </div>
            <div id="groupSelectedChips"
                style="display: flex; flex-wrap: wrap; gap: 8px; padding: 5px 0; min-height: 30px;"></div>
            <div id="groupUserList" style="max-height: 300px; overflow-y: auto;"></div>
            <div style="padding-top: 15px; text-align: right;">
                <button onclick="goToGroupStep2()" class="whatsapp-modal-btn delete"
                    style="background: var(--accent-color, #A68A64); color: black;">NEXT</button>
            </div>
        </div>
        <!-- Step 2: Group Details -->
        <div id="groupStep2" style="display: none;">
            <div
                style="display: flex; align-items: center; justify-content: space-between; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                <button onclick="backToGroupStep1()"
                    style="background: none; border: none; font-size: 1rem; cursor: pointer;">← Back</button>
                <h3 style="margin: 0; color: #333;">Group details</h3>
                <button onclick="closeNewGroupModal()"
                    style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">✕</button>
            </div>
            <div style="text-align: center; padding: 20px 0;">
                <div id="groupAvatarPreview"
                    style="width: 80px; height: 80px; border-radius: 50%; background: #A68A64; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; color: white; font-size: 2rem;">
                    <i class="fas fa-users"></i>
                </div>
                <input type="text" id="groupNameInput" placeholder="Group name"
                    style="width: 80%; padding: 10px; border: none; border-bottom: 2px solid var(--accent-color, #A68A64); font-size: 1.1rem; text-align: center; outline: none;">
            </div>
            <p style="color: #666; font-size: 0.85rem; text-align: center;">Members: <span
                    id="groupMemberCount">0</span></p>
            <div style="padding-top: 15px; text-align: right;">
                <button onclick="createGroup()" class="whatsapp-modal-btn delete"
                    style="background: var(--accent-color, #A68A64); color: black;">CREATE</button>
            </div>
        </div>
    </div>
</div>

<!-- Right-Click Context Menu -->
<div id="chatContextMenu" class="chat-context-menu"
    style="display: none; position: fixed; z-index: 9999; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); min-width: 180px; overflow: hidden;">
    <div class="context-menu-item" onclick="pinSelectedChat()"
        style="padding: 14px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;">
        <i class="fas fa-thumbtack" style="color: #888; width: 18px;"></i>
        <span id="pinMenuText" style="color: #333;">Pin</span>
    </div>
    <div class="context-menu-item" onclick="editNickname()"
        style="padding: 14px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;">
        <i class="fas fa-edit" style="color: #888; width: 18px;"></i>
        <span style="color: #333;">Edit Nickname</span>
    </div>
    <div class="context-menu-item" onclick="archiveSelectedChat()"
        style="padding: 14px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;">
        <i class="fas fa-archive" style="color: #888; width: 18px;"></i>
        <span style="color: #333;">Archive</span>
    </div>
    <div class="context-menu-item" onclick="markChatAsRead()"
        style="padding: 14px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;">
        <i class="fas fa-check-double" style="color: #888; width: 18px;"></i>
        <span style="color: #333;">Mark as Read</span>
    </div>
    <div class="context-menu-item" onclick="deleteContextChat()"
        style="padding: 14px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer;">
        <i class="fas fa-trash" style="color: #ef4444; width: 18px;"></i>
        <span style="color: #ef4444;">Delete</span>
    </div>
</div>

<style>
    .chat-context-menu .context-menu-item:hover {
        background: #f5f5f5;
    }

    .chat-context-menu .context-menu-item:active {
        background: #ebebeb;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    // --- SOCKET.IO ---
    const socket = io();

    socket.on('connect', () => {
        console.log('Connected to socket');
        // Join my user room for updates
        // We need user ID, let's grab it from a template variable or meta tag if possible
        // Current template doesn't expose it easily in JS var, but we can infer or rely on server session associated with socket
        // The server needs to know who I am. `socketio` typically handles session.
    });

    socket.on('update_unread_count', (data) => {
        // data.total_unread (int)
        // Update nav badge
        const navIcon = document.querySelector('.whatsapp-nav-icon');
        let badge = navIcon.querySelector('.whatsapp-nav-badge');

        if (data.total_unread > 0) {
            if (!badge) {
                badge = document.createElement('div');
                badge.className = 'whatsapp-nav-badge';
                navIcon.appendChild(badge);
            }
            badge.textContent = data.total_unread;
        } else {
            if (badge) badge.remove();
        }

        // Update specific row if data provides it
        if (data.sender_id) {
            const row = document.querySelector(`.whatsapp-list-row[data-user-id="${data.sender_id}"]`);
            if (row) {
                // Determine new count (logic usually handled by reloading or discrete event)
                // Ideally server sends {sender_id: 5, new_count: 2}
                if (data.new_count !== undefined) {
                    let rowBadge = row.querySelector('.whatsapp-unread-badge');
                    if (data.new_count > 0) {
                        if (!rowBadge) {
                            const meta = row.querySelector('.whatsapp-list-meta');
                            rowBadge = document.createElement('div');
                            rowBadge.className = 'whatsapp-unread-badge';
                            meta.appendChild(rowBadge);
                        }
                        rowBadge.textContent = data.new_count;
                        row.querySelector('.whatsapp-list-time').classList.add('active');
                        row.dataset.unread = data.new_count;
                    } else {
                        if (rowBadge) rowBadge.remove();
                        row.querySelector('.whatsapp-list-time').classList.remove('active');
                        row.dataset.unread = 0;
                    }
                }
            }
        }
    });

    socket.on('read_receipt', (data) => {
        // reader_id is the user who read our message
        const row = document.querySelector(`.whatsapp-list-row[data-user-id="${data.reader_id}"]`);
        if (row) {
            const icon = row.querySelector('.read-receipt-icon');
            if (icon) {
                icon.style.color = '#34b7f1'; // WhatsApp Blue
            }
        }
    });

    // --- DROPDOWNS ---
    function toggleDropdown(id) {
        // Close others
        document.querySelectorAll('.whatsapp-dropdown-menu').forEach(d => {
            if (d.id !== id) d.classList.remove('show');
        });
        const d = document.getElementById(id);
        d.classList.toggle('show');
    }

    // Close on click outside
    window.onclick = function (event) {
        if (!event.target.closest('.whatsapp-control-btn') && !event.target.closest('.whatsapp-dropdown-menu')) {
            document.querySelectorAll('.whatsapp-dropdown-menu').forEach(d => d.classList.remove('show'));
        }
    }

    // --- FILTERING / SEARCH ---
    function filterChatsDebounced() {
        const input = document.querySelector('.whatsapp-search-input');
        const filter = input.value.toLowerCase();
        const rows = document.querySelectorAll('.whatsapp-list-row');

        rows.forEach(row => {
            const nameEl = row.querySelector('.whatsapp-list-name');
            const name = nameEl.textContent.toLowerCase();

            // Logic: Search matches names. Check unread status if that filter is active?
            // User request: "searching the current chats based on the username"
            // We should respect the active tab filter + text search
            const activeTab = document.querySelector('.whatsapp-filter-chip.active');
            let isVisible = true;

            // Name match
            if (filter && !name.includes(filter)) {
                isVisible = false;
            }

            // Tab match
            if (activeTab && isVisible) { // Only check if still visible
                const type = activeTab.textContent.trim().split(' ')[0].toLowerCase(); // "All", "Unread", "Groups"
                if (type === 'unread') {
                    if (parseInt(row.dataset.unread || 0) === 0) isVisible = false;
                } else if (type === 'groups') {
                    if (row.dataset.type !== 'group') isVisible = false;
                }
            }

            row.style.display = isVisible ? 'flex' : 'none';
        });
    }

    function setFilter(type, btn) {
        // Visual update
        document.querySelectorAll('.whatsapp-filter-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        filterChatsDebounced(); // Re-run search logic with new filter
    }

    // --- READ ALL ---
    function markAllAsRead() {
        toggleDropdown('moreOptionsDropdown');
        fetch('/api/messages/mark_all_read', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    document.querySelectorAll('.whatsapp-unread-badge').forEach(el => el.remove());
                    document.querySelectorAll('.whatsapp-list-time.active').forEach(el => el.classList.remove('active'));
                    document.querySelectorAll('.whatsapp-nav-badge').forEach(el => el.remove());
                    document.querySelectorAll('.whatsapp-list-row').forEach(row => row.dataset.unread = '0');

                    // Refresh filter
                    filterChatsDebounced();
                }
            });
    }

    // --- SELECTION MODE ---
    let isSelectionMode = false;
    let selectedChats = new Set();

    function enterSelectionMode() {
        toggleDropdown('moreOptionsDropdown');
        isSelectionMode = true;
        document.querySelectorAll('.whatsapp-list-row').forEach(row => row.classList.add('selection-mode'));
        document.getElementById('listBatchBar').style.display = 'flex';
        document.querySelector('.whatsapp-bottom-nav').style.display = 'none'; // Hide nav
    }

    function exitSelectionMode() {
        isSelectionMode = false;
        selectedChats.clear();
        document.querySelectorAll('.whatsapp-list-row').forEach(row => {
            row.classList.remove('selection-mode', 'selected');
            // Reset checkbox visual if needed (CSS handles uncheck via class removal)
        });
        document.getElementById('listBatchBar').style.display = 'none';
        document.querySelector('.whatsapp-bottom-nav').style.display = 'flex';
        updateSelectionCount();
    }

    function handleRowClick(row, url) {
        if (isSelectionMode) {
            const id = row.dataset.userId;
            if (selectedChats.has(id)) {
                selectedChats.delete(id);
                row.classList.remove('selected');
            } else {
                selectedChats.add(id);
                row.classList.add('selected');
            }
            updateSelectionCount();
        } else {
            // Only navigate if not clicking the checkbox container specifically (though row click covers it)
            // Just standard nav
            window.location.href = url;
        }
    }

    function updateSelectionCount() {
        document.getElementById('listSelectedCount').textContent = `${selectedChats.size} selected`;
    }

    // --- DELETE LOGIC ---
    function deleteSelectedChats() {
        if (selectedChats.size === 0) return;
        // Show Custom Modal
        const modal = document.getElementById('deleteModal');
        modal.classList.add('show');

        // Update text? "Delete 3 chats?"
        // User image 3 just says "Delete chat" singular title, text: "Are you sure you want to delete the chat with [Name]?"
        // Since we are batch deleting, generic text "Are you sure you want to delete the selected chat(s)?" is safer.
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.remove('show');
    }

    function confirmDeleteChats() {
        const forEveryone = document.getElementById('deleteForEveryone').checked;
        const ids = Array.from(selectedChats); // [1, 2, 5]

        const formData = new FormData();
        ids.forEach(id => formData.append('message_ids[]', id)); // Actually we are deleting chats (users), not message IDs.
        // Wait, "Delete Chat" means deleting the conversation with User X.
        // The backend `delete_batch` route I see handles MESSAGE IDs.
        // I need a batch logic to delete CHATS (conversations).
        // `delete_chat_conversation` route takes a single user_id.
        // I should probably iterate and call it for each, OR create a new batch route.
        // For now, let's just loop fetch calls or use a new endpoint.

        // Let's implement client-side loop for simplicity as there's no batch-delete-chat endpoint yet.

        const promises = ids.map(userId => {
            return fetch(`/messages/delete-chat/${userId}`, { method: 'POST' });
        });

        Promise.all(promises).then(() => {
            // Remove from UI
            ids.forEach(id => {
                const row = document.querySelector(`.whatsapp-list-row[data-user-id="${id}"]`);
                if (row) row.remove();
            });
            closeDeleteModal();
            exitSelectionMode();
        });
    }

    // ==========================
    // NEW CHAT / NEW GROUP LOGIC
    // ==========================
    let allUsers = [];
    let selectedGroupMembers = new Set();

    async function fetchAllUsers() {
        if (allUsers.length > 0) return allUsers;
        try {
            const res = await fetch('/api/users/all');
            const data = await res.json();
            if (data.status === 'success') {
                allUsers = data.users;
            }
        } catch (e) {
            console.error('Failed to fetch users:', e);
        }
        return allUsers;
    }

    // --- NEW CHAT MODAL ---
    async function openNewChatModal() {
        closeDropdowns();
        const modal = document.getElementById('newChatModal');
        modal.classList.add('show');

        await fetchAllUsers();
        renderNewChatUserList(allUsers);
    }

    function closeNewChatModal() {
        document.getElementById('newChatModal').classList.remove('show');
        document.getElementById('newChatSearch').value = '';
    }

    function renderNewChatUserList(users) {
        const container = document.getElementById('newChatUserList');
        if (users.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No users found.</p>';
            return;
        }
        container.innerHTML = users.map(u => `
            <div class="new-chat-user-row" onclick="startChatWith(${u.id})" style="display: flex; align-items: center; gap: 12px; padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;">
                <img src="${u.profile_pic}" style="width: 45px; height: 45px; border-radius: 50%;">
                <div>
                    <div style="font-weight: 500; color: #333;">${u.username}</div>
                    <div style="font-size: 0.85rem; color: #888;">${u.bio || ''}</div>
                </div>
            </div>
        `).join('');
    }

    function filterNewChatUsers() {
        const query = document.getElementById('newChatSearch').value.toLowerCase();
        const filtered = allUsers.filter(u => u.username.toLowerCase().includes(query));
        renderNewChatUserList(filtered);
    }

    function startChatWith(userId) {
        window.location.href = `/messages/${userId}`;
    }

    // --- NEW GROUP MODAL ---
    async function openNewGroupModal() {
        closeDropdowns();
        selectedGroupMembers.clear();
        const modal = document.getElementById('newGroupModal');
        modal.classList.add('show');

        // Reset to step 1
        document.getElementById('groupStep1').style.display = '';
        document.getElementById('groupStep2').style.display = 'none';
        document.getElementById('groupUserSearch').value = '';
        document.getElementById('groupSelectedChips').innerHTML = '';
        document.getElementById('groupNameInput').value = '';

        await fetchAllUsers();
        renderGroupUserList(allUsers);
    }

    function closeNewGroupModal() {
        document.getElementById('newGroupModal').classList.remove('show');
    }

    function renderGroupUserList(users) {
        const container = document.getElementById('groupUserList');
        if (users.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No users found.</p>';
            return;
        }
        container.innerHTML = users.map(u => `
            <div class="group-user-row" onclick="toggleGroupMember(${u.id}, '${u.username}', '${u.profile_pic}')" style="display: flex; align-items: center; gap: 12px; padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; ${selectedGroupMembers.has(u.id) ? 'background: rgba(166,138,100,0.1);' : ''}">
                <img src="${u.profile_pic}" style="width: 45px; height: 45px; border-radius: 50%;">
                <div style="flex: 1;">
                    <div style="font-weight: 500; color: #333;">${u.username}</div>
                </div>
                <div style="width: 22px; height: 22px; border-radius: 50%; border: 2px solid ${selectedGroupMembers.has(u.id) ? '#A68A64' : '#ccc'}; display: flex; align-items: center; justify-content: center; background: ${selectedGroupMembers.has(u.id) ? '#A68A64' : 'transparent'};">
                    ${selectedGroupMembers.has(u.id) ? '<i class="fas fa-check" style="color: white; font-size: 0.7rem;"></i>' : ''}
                </div>
            </div>
        `).join('');
    }

    function toggleGroupMember(userId, username, profilePic) {
        if (selectedGroupMembers.has(userId)) {
            selectedGroupMembers.delete(userId);
        } else {
            selectedGroupMembers.add(userId);
        }
        renderGroupUserList(allUsers.filter(u => u.username.toLowerCase().includes(document.getElementById('groupUserSearch').value.toLowerCase())));
        updateChips();
    }

    function updateChips() {
        const container = document.getElementById('groupSelectedChips');
        const members = Array.from(selectedGroupMembers);
        const userMap = {};
        allUsers.forEach(u => userMap[u.id] = u);

        container.innerHTML = members.map(id => {
            const u = userMap[id];
            if (!u) return '';
            return `<div style="display: flex; align-items: center; gap: 5px; background: #f0f0f0; padding: 5px 10px; border-radius: 20px; font-size: 0.85rem;">
                <img src="${u.profile_pic}" style="width: 20px; height: 20px; border-radius: 50%;">
                ${u.username}
                <span onclick="removeGroupMember(${id})" style="cursor: pointer; margin-left: 5px;">&times;</span>
            </div>`;
        }).join('');
    }

    function removeGroupMember(userId) {
        selectedGroupMembers.delete(userId);
        renderGroupUserList(allUsers.filter(u => u.username.toLowerCase().includes(document.getElementById('groupUserSearch').value.toLowerCase())));
        updateChips();
    }

    function filterGroupUsers() {
        const query = document.getElementById('groupUserSearch').value.toLowerCase();
        const filtered = allUsers.filter(u => u.username.toLowerCase().includes(query));
        renderGroupUserList(filtered);
    }

    function goToGroupStep2() {
        if (selectedGroupMembers.size < 2) {
            alert('Please select at least 2 members.');
            return;
        }
        document.getElementById('groupStep1').style.display = 'none';
        document.getElementById('groupStep2').style.display = '';
        document.getElementById('groupMemberCount').textContent = selectedGroupMembers.size;
    }

    function backToGroupStep1() {
        document.getElementById('groupStep1').style.display = '';
        document.getElementById('groupStep2').style.display = 'none';
    }

    async function createGroup() {
        const name = document.getElementById('groupNameInput').value.trim() || 'New Group';
        const memberIds = Array.from(selectedGroupMembers);

        try {
            const res = await fetch('/api/groups/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, member_ids: memberIds })
            });
            const data = await res.json();

            if (data.status === 'success') {
                window.location.href = data.redirect_url;
            } else {
                alert(data.message || 'Failed to create group.');
            }
        } catch (e) {
            console.error('Create group error:', e);
            alert('Failed to create group.');
        }
    }

    function closeDropdowns() {
        document.getElementById('newChatDropdown').classList.remove('show');
        document.getElementById('moreOptionsDropdown').classList.remove('show');
    }

    // ==========================
    // RIGHT-CLICK CONTEXT MENU
    // ==========================
    let contextMenuTargetUserId = null;
    let contextMenuTargetType = 'private';
    const contextMenu = document.getElementById('chatContextMenu');

    // Attach right-click handler to all chat rows
    document.querySelectorAll('.whatsapp-list-row').forEach(row => {
        row.addEventListener('contextmenu', function (e) {
            e.preventDefault();

            contextMenuTargetUserId = this.dataset.userId;
            contextMenuTargetType = this.dataset.type || 'private';
            const isPinned = this.dataset.pinned === 'true';
            document.getElementById('pinMenuText').textContent = isPinned ? 'Unpin' : 'Pin';

            // Position menu
            const menu = document.getElementById('chatContextMenu');
            menu.style.display = 'block';

            // Ensure menu stays within viewport
            const menuWidth = menu.offsetWidth;
            const menuHeight = menu.offsetHeight;
            let x = e.clientX;
            let y = e.clientY;

            if (x + menuWidth > window.innerWidth) {
                x = window.innerWidth - menuWidth - 10;
            }
            if (y + menuHeight > window.innerHeight) {
                y = window.innerHeight - menuHeight - 10;
            }

            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
        });
    });

    // Hide context menu on click elsewhere
    document.addEventListener('click', function (e) {
        if (!contextMenu.contains(e.target)) {
            contextMenu.style.display = 'none';
        }
    });

    // Hide context menu on scroll
    document.addEventListener('scroll', function () {
        contextMenu.style.display = 'none';
    }, true);

    // --- Context Menu Actions ---

    function sortChats() {
        const container = document.getElementById('conversationsContainer');
        const rows = Array.from(container.querySelectorAll('.whatsapp-list-row'));

        rows.sort((a, b) => {
            const pinnedA = a.dataset.pinned === 'true';
            const pinnedB = b.dataset.pinned === 'true';

            if (pinnedA && !pinnedB) return -1;
            if (!pinnedA && pinnedB) return 1;

            // If both pinned or both unpinned, sort by timestamp
            const timeA = parseInt(a.dataset.timestamp || 0);
            const timeB = parseInt(b.dataset.timestamp || 0);

            return timeB - timeA; // Descending
        });

        // Re-append
        rows.forEach(row => container.appendChild(row));
    }

    async function pinSelectedChat() {
        if (!contextMenuTargetUserId) return;
        contextMenu.style.display = 'none';

        try {
            let url;
            if (contextMenuTargetType === 'group') {
                url = `/api/chats/pin_group/${contextMenuTargetUserId}`;
            } else {
                url = `/api/chats/pin/${contextMenuTargetUserId}`;
            }

            const res = await fetch(url, { method: 'POST' });
            const data = await res.json();

            if (data.status === 'success') {
                const row = document.querySelector(`.whatsapp-list-row[data-user-id="${contextMenuTargetUserId}"]`);
                if (row) {
                    if (data.pinned) {
                        row.dataset.pinned = 'true';
                        // Add pin indicator if not exists
                        let pinIcon = row.querySelector('.whatsapp-pinned-icon');
                        if (!pinIcon) {
                            const metaDiv = row.querySelector('.whatsapp-list-meta');
                            if (metaDiv) {
                                const pin = document.createElement('i');
                                pin.className = 'fas fa-thumbtack whatsapp-pinned-icon';
                                pin.style.cssText = 'color: var(--accent-color); font-size: 0.75rem;';
                                metaDiv.insertBefore(pin, metaDiv.firstChild);
                            }
                        }
                    } else {
                        row.dataset.pinned = 'false';
                        // Remove pin indicator
                        const pinIcon = row.querySelector('.whatsapp-pinned-icon');
                        if (pinIcon) pinIcon.remove();
                    }

                    // Re-sort list
                    sortChats();

                    // Show message? (Optional)
                }
            }
        } catch (e) {
            console.error('Pin error:', e);
        }
    }

    async function editNickname() {
        if (!contextMenuTargetUserId) return;
        contextMenu.style.display = 'none';

        // Get current nickname
        const row = document.querySelector(`.whatsapp-list-row[data-user-id="${contextMenuTargetUserId}"]`);
        const currentName = row ? row.querySelector('.whatsapp-list-name').textContent.trim() : '';

        try {
            const res = await fetch(`/api/chats/nickname/${contextMenuTargetUserId}`);
            const data = await res.json();
            const currentNickname = data.nickname || '';

            const newNickname = prompt('Edit Nickname:', currentNickname);
            if (newNickname === null) return; // Cancelled

            const postRes = await fetch(`/api/chats/nickname/${contextMenuTargetUserId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nickname: newNickname })
            });
            const postData = await postRes.json();

            if (postData.status === 'success') {
                // Update UI - show nickname if set, otherwise keep original
                if (row) {
                    const nameEl = row.querySelector('.whatsapp-list-name');
                    if (nameEl && newNickname) {
                        nameEl.textContent = newNickname;
                    }
                }
            }
        } catch (e) {
            console.error('Nickname error:', e);
        }
    }

    async function archiveSelectedChat() {
        if (!contextMenuTargetUserId) return;
        contextMenu.style.display = 'none';

        try {
            const res = await fetch(`/api/chats/archive/${contextMenuTargetUserId}`, { method: 'POST' });
            const data = await res.json();

            if (data.status === 'success') {
                // Remove from UI (move to archived section)
                const row = document.querySelector(`.whatsapp-list-row[data-user-id="${contextMenuTargetUserId}"]`);
                if (row) row.remove();

                // Update archived count
                const archiveCount = document.querySelector('.whatsapp-archive-row > div:last-child');
                if (archiveCount) {
                    archiveCount.textContent = parseInt(archiveCount.textContent) + 1;
                }
            }
        } catch (e) {
            console.error('Archive error:', e);
        }
    }

    async function markChatAsRead() {
        if (!contextMenuTargetUserId) return;
        contextMenu.style.display = 'none';

        try {
            const res = await fetch(`/api/messages/mark_read/${contextMenuTargetUserId}`, { method: 'POST' });
            const data = await res.json();

            if (data.status === 'success') {
                // Update UI - remove unread badge
                const row = document.querySelector(`.whatsapp-list-row[data-user-id="${contextMenuTargetUserId}"]`);
                if (row) {
                    row.dataset.unread = '0';
                    const badge = row.querySelector('.whatsapp-unread-badge');
                    if (badge) badge.remove();
                    const time = row.querySelector('.whatsapp-list-time');
                    if (time) time.classList.remove('active');
                }
            }
        } catch (e) {
            console.error('Mark read error:', e);
        }
    }

    async function deleteContextChat() {
        if (!contextMenuTargetUserId) return;
        contextMenu.style.display = 'none';

        // Use the same delete logic as selection mode
        selectedChats.clear();
        selectedChats.add(contextMenuTargetUserId);
        deleteSelectedChats();
    }
</script>


{% include 'partials/chatbot.html' %}
{% endblock %}