{% extends 'base.html' %}

{% block content %}
<div class="row">
    <!-- Sidebar Navigation -->
    <div class="col-lg-3 mb-4">
        <div class="card nav-card-minimal">
            <div class="card-body p-0">
                <div class="text-center p-4 border-bottom">
                    {% if user.profile_pic %}
                    <img src="{{ user.profile_pic }}" class="rounded-circle mb-3"
                        style="width: 80px; height: 80px; object-fit: cover;">
                    {% else %}
                    <div class="rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center"
                        style="width: 80px; height: 80px; background-color: var(--accent-color);">
                        <i class="fas fa-user fa-2x" style="color: var(--primary-color);"></i>
                    </div>
                    {% endif %}
                    <h5 class="fw-bold mb-1">{{ user.full_name }}</h5>
                    <span class="badge bg-light text-muted">{{ user.user_type }}</span>
                </div>
                <nav class="nav flex-column">
                    <a class="nav-link active py-3 px-4 border-bottom" href="#profile-info" data-section="profile-info">
                        <i class="fas fa-user me-2"></i>{{ _('Profile Info') }}
                    </a>
                    <a class="nav-link py-3 px-4 border-bottom" href="#notifications" data-section="notifications">
                        <i class="fas fa-bell me-2"></i>{{ _('Notifications') }}
                    </a>
                    <a class="nav-link py-3 px-4 border-bottom" href="#appearance" data-section="appearance">
                        <i class="fas fa-palette me-2"></i>{{ _('Appearance') }}
                    </a>
                    <a class="nav-link py-3 px-4" href="#privacy" data-section="privacy">
                        <i class="fas fa-shield-alt me-2"></i>{{ _('Privacy & Security') }}
                    </a>
                </nav>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-9">
        <!-- Profile Info Section -->
        <div class="card nav-card-minimal mb-4" id="profile-info">
            <div class="card-header bg-transparent border-bottom py-3">
                <h5 class="mb-0 fw-bold"><i class="fas fa-user me-2" style="color: var(--primary-color);"></i><span>{{
                        _('Profile Info') }}</span></h5>
            </div>
            <div class="card-body p-4">
                <form action="{{ url_for('auth.update_profile') }}" method="POST" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="full_name" class="form-label fw-bold">{{ _('Full Name') }}</label>
                            <input type="text" class="form-control" id="full_name" name="full_name"
                                value="{{ user.full_name }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="username" class="form-label fw-bold">{{ _('Username') }}</label>
                            <input type="text" class="form-control" id="username" name="username"
                                value="{{ user.username }}" required pattern="[a-zA-Z0-9_]{3,20}">
                            <div class="form-text">{{ _('3-20 characters, letters, numbers, and underscores only.') }}
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="bio" class="form-label fw-bold">{{ _('Bio') }}</label>
                        <textarea class="form-control" id="bio" name="bio" rows="3"
                            placeholder="{{ _('Tell us about yourself...') }}">{{ user.bio or '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="profile_pic" class="form-label fw-bold">{{ _('Profile Picture') }}</label>
                        <input type="file" class="form-control" id="profile_pic" name="profile_pic" accept="image/*">
                        <div class="form-text">{{ _('Upload a new photo to update your profile picture.') }}</div>
                    </div>

                    <!-- Hidden notification fields (will be handled by checkboxes below visually but we need them in form) -->
                    <!-- Integrating notification settings into this form requires the checkboxes to be inside the form tag. -->
                    <!-- Since the design has them in separate cards, we either need JS to sync them or move the form tag to wrap everything. -->
                    <!-- Easier approach: Make the checkboxes part of this form or have a separate settings form. -->
                    <!-- Given the current layout, let's wrap the ENTIRE content in the form? No, layout breaks. -->
                    <!-- We will add hidden inputs here that JS updates, OR we simply move the Save button to be global? -->
                    <!-- Users expect separate sections. Let's make the notification checkboxes submit via AJAX or have their own save button? -->
                    <!-- User request implies "Turn on or off from the profile page". -->
                    <!-- Let's wrap the notification section in inputs with names matching our backend logic, BUT they are outside this form. -->
                    <!-- FIX: We will move the </form> tag to the very end of the main content column so one "Save Changes" button updates everything, OR we add a save button to each section. -->
                    <!-- Better: One big form for the whole profile page. -->

                    <!-- Closing the form here for Profile Info section, we will assume user clicks "Save" here for basic info. -->
                    <!-- WAIT, the backend expects everything in one POST. -->
                    <!-- We should combine them. -->

                    <button type="submit" class="btn btn-primary">{{ _('Save Changes') }}</button>

                    <!-- We need to include notification settings in this POST if the backend expects them. -->
                    <!-- Current backend code resets them to 0 if missing. -->
                    <!-- We MUST include them here as hidden inputs if we want one button, OR we change the form scope. -->
                    <!-- Let's change the Template Structure to wrap all cards in one <form> if possible, or use JS to capture values. -->
                    <!-- JS Approach is safest without breaking layout: On submit of this form, append notification values. -->
                </form>
            </div>
        </div>

        <!-- Notifications Section -->
        <div class="card nav-card-minimal mb-4" id="notifications">
            <div class="card-header bg-transparent border-bottom py-3">
                <h5 class="mb-0 fw-bold"><i class="fas fa-bell me-2" style="color: var(--primary-color);"></i><span>{{
                        _('Notifications') }}</span></h5>
            </div>
            <div class="card-body p-4">
                <form action="{{ url_for('auth.update_notifications') }}" method="POST" id="notificationForm">
                    <!-- We need hidden fields for the profile info so we don't lose it if we save here? No, let's just save notifications. -->
                    <!-- Actually the backend updates ALL at once. This is tricky. -->
                    <!-- Let's just use AJAX for notifications or make them separate routes. -->
                    <!-- For now, simplest solution: Add names to these checkboxes and when they change, we can trigger a save OR we rely on the implementation plan to make one big form. -->
                    <!-- I will restructure the page to have ONE form wrapping all sections. -->

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="notify_messages" name="notify_messages"
                            {{ 'checked' if user.notify_messages else '' }}>
                        <label class="form-check-label" for="notify_messages">
                            <strong>{{ _('New Messages') }}</strong>
                            <br><small class="text-muted">{{ _('Get notified when you receive new messages') }}</small>
                        </label>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="notify_activities" name="notify_activities"
                            {{ 'checked' if user.notify_activities else '' }}>
                        <label class="form-check-label" for="notify_activities">
                            <strong>{{ _('Activity Reminders') }}</strong>
                            <br><small class="text-muted">{{ _("Reminders for activities you've joined") }}</small>
                        </label>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="notify_stories" name="notify_stories"
                            {{ 'checked' if user.notify_stories else '' }}>
                        <label class="form-check-label" for="notify_stories">
                            <strong>{{ _('Story Interactions') }}</strong>
                            <br><small class="text-muted">{{ _('When someone likes or comments on your stories')
                                }}</small>
                        </label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="notify_groups" name="notify_groups"
                            {{ 'checked' if user.notify_groups else '' }}>
                        <label class="form-check-label" for="notify_groups">
                            <strong>{{ _('Group Updates') }}</strong>
                            <br><small class="text-muted">{{ _('When you join a group or someone joins your group')
                                }}</small>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3">{{ _('Save Notification Settings') }}</button>
                </form>
            </div>
        </div>

        <!-- Appearance Section -->
        <div class="card nav-card-minimal mb-4" id="appearance">
            <div class="card-header bg-transparent border-bottom py-3">
                <h5 class="mb-0 fw-bold"><i class="fas fa-palette me-2"
                        style="color: var(--primary-color);"></i><span>{{ _('Appearance') }}</span></h5>
            </div>
            <div class="card-body p-4">
                <div class="mb-4">
                    <label class="form-label fw-bold">{{ _('Theme') }}</label>
                    <div class="d-flex gap-3">
                        <div class="form-check">
                            <input class="form-check-input topic-theme-btn" type="radio" name="theme" id="theme_light"
                                value="light" onclick="setTheme('light')">
                            <label class="form-check-label" for="theme_light">
                                <i class="fas fa-sun me-1"></i><span>{{ _('Light') }}</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input topic-theme-btn" type="radio" name="theme" id="theme_dark"
                                value="dark" onclick="setTheme('dark')">
                            <label class="form-check-label" for="theme_dark">
                                <i class="fas fa-moon me-1"></i><span>{{ _('Dark') }}</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">{{ _('Language') }}</label>
                    <form action="{{ url_for('auth.update_language') }}" method="POST"
                        class="d-flex gap-2 align-items-center">
                        <select name="language" class="form-select" style="max-width: 200px;"
                            onchange="this.form.submit()">
                            <option value="en" {{ 'selected' if user.language=='en' or not user.language else '' }}>ðŸ‡¬ðŸ‡§
                                {{ _('English') }}</option>
                            <option value="zh_CN" {{ 'selected' if user.language=='zh_CN' else '' }}>ðŸ‡¨ðŸ‡³ {{
                                _('Chinese') }}</option>
                            <option value="ms" {{ 'selected' if user.language=='ms' else '' }}>ðŸ‡²ðŸ‡¾ {{
                                _('Malay') }}</option>
                            <option value="ta" {{ 'selected' if user.language=='ta' else '' }}>ðŸ‡®ðŸ‡³ {{
                                _('Tamil') }}</option>
                        </select>
                        <noscript><button type="submit" class="btn btn-sm btn-primary">{{ _('Save')
                                }}</button></noscript>
                    </form>
                    <div class="form-text">{{ _('Select your preferred language for the interface.') }}</div>
                </div>
            </div>
        </div>

        <!-- Privacy & Security Section -->
        <div class="card nav-card-minimal mb-4" id="privacy">
            <div class="card-header bg-transparent border-bottom py-3">
                <h5 class="mb-0 fw-bold"><i class="fas fa-shield-alt me-2"
                        style="color: var(--primary-color);"></i><span>{{ _('Privacy & Security') }}</span></h5>
            </div>
            <div class="card-body p-4">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="profile_public" checked>
                    <label class="form-check-label" for="profile_public">
                        <strong>{{ _('Public Profile') }}</strong>
                        <br><small class="text-muted">{{ _('Allow others to see your profile and stories') }}</small>
                    </label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="show_online" checked>
                    <label class="form-check-label" for="show_online">
                        <strong>{{ _('Show Online Status') }}</strong>
                        <br><small class="text-muted">{{ _("Let others see when you're active") }}</small>
                    </label>
                </div>
                <div class="form-check form-switch mb-4">
                    <input class="form-check-input" type="checkbox" id="allow_messages" checked>
                    <label class="form-check-label" for="allow_messages">
                        <strong>{{ _('Allow Messages') }}</strong>
                        <br><small class="text-muted">{{ _('Receive messages from other community members') }}</small>
                    </label>
                </div>
                <hr>
                <div class="mt-3">
                    <a href="{{ url_for('auth.change_password') }}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-key me-1"></i> {{ _('Change Password') }}
                    </a>
                    <form action="{{ url_for('auth.delete_account') }}" method="POST"
                        onsubmit="return confirm('WARNING: Are you sure you want to delete your account? This action cannot be undone.');"
                        style="display:inline;">
                        <button type="submit" class="btn btn-outline-danger"><i class="fas fa-trash me-1"></i> {{
                            _('Delete Account') }}</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .nav-link.active {
        background-color: var(--accent-color);
        color: var(--primary-color) !important;
        font-weight: bold;
    }

    .nav-link:hover:not(.active) {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}