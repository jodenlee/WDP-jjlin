{% extends 'base.html' %}

{% block extra_head %}
<!-- SortableJS for media rearrangement -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
    .image-container:hover {
        cursor: move;
    }

    .sortable-ghost {
        opacity: 0.4;
        border: 2px dashed var(--primary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
        <div class="mb-3">
            <a href="{{ url_for('stories.stories_list') }}" class="btn btn-primary btn-lg fs-4">← Back to Stories</a>
        </div>
        <div class="form-container">
            <h1 class="mb-4">{{ _('Edit Story') }}</h1>
            <form method="POST" class="story-form" enctype="multipart/form-data" novalidate>
                <div class="mb-3">
                    <label for="title" class="form-label fw-bold fs-5">{{ _('Title') }}</label>
                    <div class="input-group">
                        <input type="text" id="title" name="title" class="form-control form-control-lg"
                            value="{{ story['title'] }}" required minlength="3" maxlength="100">
                        <select class="form-select lang-selector border-start-0" id="title-lang">
                            <option value="en-SG" selected>EN</option>
                            <option value="zh-CN">中</option>
                        </select>
                        <button type="button" class="btn btn-outline-secondary" id="title-stt-btn"
                            onclick="toggleSpeechRecognition('title-stt-btn', 'title', 'title-lang')"
                            title="Speak Title">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary clear-btn" onclick="clearInput('title')"
                            title="Clear Title">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="form-text">{{ _('Title must be between 3 and 100 characters.') }}</div>
                </div>

                <div class="mb-3">
                    <label for="content" class="form-label fw-bold fs-5">{{ _('Story Content') }}</label>
                    <div class="input-group">
                        <textarea id="content" name="content" rows="6" class="form-control form-control-lg" required
                            minlength="10">{{ story['content'] }}</textarea>
                        <div class="d-flex flex-column border rounded-end bg-light overflow-hidden"
                            style="width: 45px;">
                            <button type="button" class="btn btn-outline-secondary border-0 clear-btn py-2"
                                onclick="clearInput('content')" title="Clear Content"
                                style="border-bottom: 1px solid #dee2e6 !important; border-radius: 0;">
                                <i class="fas fa-times"></i>
                            </button>
                            <div class="flex-grow-1 d-flex align-items-center justify-content-center border-bottom">
                                <select class="form-select border-0 bg-transparent lang-selector p-0 text-center"
                                    id="content-lang" style="box-shadow: none; height: 35px;">
                                    <option value="en-SG" selected>EN</option>
                                    <option value="zh-CN">中</option>
                                </select>
                            </div>
                            <button type="button" class="btn btn-outline-secondary border-0 py-3" id="content-stt-btn"
                                onclick="toggleSpeechRecognition('content-stt-btn', 'content', 'content-lang')"
                                title="Speak Story Content">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-text">{{ _('Share at least 10 characters about your story.') }}</div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold fs-5">{{ _('Manage Medias') }}</label>
                    <div class="d-flex flex-wrap gap-3 mb-3" id="images-gallery">
                        <input type="hidden" name="media_order" id="media-order-input">
                        {% if story['image_url'] %}
                        <div class="d-flex flex-column align-items-center gap-2 image-container"
                            id="main-image-container" data-id="main">
                            <div class="border rounded p-1" style="width: 150px; height: 150px;">
                                {% if story['image_url'].lower().endswith(('.mp4', '.mov', '.avi', '.webm')) %}
                                <video src="{{ story['image_url'] }}" class="w-100 h-100 object-fit-cover bg-black"
                                    controls muted></video>
                                {% else %}
                                <img src="{{ story['image_url'] }}" class="w-100 h-100 object-fit-cover"
                                    alt="Main Image">
                                {% endif %}
                            </div>
                            <button type="button" class="btn btn-danger btn-sm delete-main-image-btn"
                                style="width: 150px;"
                                data-url="{{ url_for('stories.delete_main_image', story_id=story['id']) }}">
                                {{ _('Delete') }}
                            </button>
                        </div>
                        {% endif %}

                        {% for img in story_images %}
                        <div class="d-flex flex-column align-items-center gap-2 image-container"
                            id="image-{{ img['id'] }}" data-id="{{ img['id'] }}">
                            <div class="border rounded p-1" style="width: 150px; height: 150px;">
                                {% if img['image_path'].lower().endswith(('.mp4', '.mov', '.avi', '.webm')) %}
                                {% if img['image_path'].startswith('http') %}
                                <video src="{{ img['image_path'] }}" class="w-100 h-100 object-fit-cover bg-black"
                                    controls muted></video>
                                {% else %}
                                <video src="{{ url_for('static', filename=img['image_path']) }}"
                                    class="w-100 h-100 object-fit-cover bg-black" controls muted></video>
                                {% endif %}
                                {% else %}
                                {% if img['image_path'].startswith('http') %}
                                <img src="{{ img['image_path'] }}" class="w-100 h-100 object-fit-cover" alt="Image">
                                {% else %}
                                <img src="{{ url_for('static', filename=img['image_path']) }}"
                                    class="w-100 h-100 object-fit-cover" alt="Image">
                                {% endif %}
                                {% endif %}
                            </div>
                            <button type="button" class="btn btn-danger btn-sm delete-image-btn" style="width: 150px;"
                                data-image-id="{{ img['id'] }}"
                                data-url="{{ url_for('stories.delete_story_image', story_id=story['id'], image_id=img['id']) }}">
                                Delete
                            </button>
                        </div>
                        {% endfor %}

                        <!-- Container for new image previews -->
                        <div id="new-images-container" class="d-flex flex-wrap gap-3"></div>
                    </div>

                    <!-- Hidden file input -->
                    <input type="file" id="hidden-image-input" name="images" class="d-none" accept="image/*,video/*"
                        multiple>

                    <button type="button" id="add-image-btn" class="btn btn-primary d-flex align-items-center gap-2">
                        <i class="fas fa-plus"></i> {{ _('Add Media') }}
                    </button>
                    <div class="form-text mt-2">{{ _('New media will be added to the existing carousel. Supported: jpg,
                        png, webm, mp4.') }}</div>
                </div>

                <!-- script for dynamic inputs -->
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const gallery = document.getElementById('images-gallery');
                        const orderInput = document.getElementById('media-order-input');
                        let sortable;

                        // Initialize SortableJS
                        if (gallery) {
                            sortable = new Sortable(gallery, {
                                animation: 150,
                                ghostClass: 'sortable-ghost',
                                draggable: '.image-container',
                                onEnd: function () {
                                    updateOrder();
                                }
                            });
                        }

                        function updateOrder() {
                            if (orderInput && sortable) {
                                orderInput.value = sortable.toArray().join(',');
                            }
                        }

                        // Initial order
                        updateOrder();

                        const addBtn = document.getElementById('add-image-btn');
                        const hiddenInput = document.getElementById('hidden-image-input');
                        const newImagesContainer = document.getElementById('new-images-container');

                        // Store all selected files
                        let selectedFiles = [];

                        // Click "Add Image" opens file picker
                        addBtn.addEventListener('click', function () {
                            hiddenInput.click();
                        });

                        // When files are selected, show previews
                        hiddenInput.addEventListener('change', function (e) {
                            const files = Array.from(e.target.files);

                            files.forEach((file) => {
                                const isImage = file.type.startsWith('image/');
                                const isVideo = file.type.startsWith('video/');
                                if (!isImage && !isVideo) return;

                                const fileIndex = selectedFiles.length;
                                selectedFiles.push(file);

                                const div = document.createElement('div');
                                div.className = 'd-flex flex-column align-items-center gap-2 image-container new-media';
                                div.dataset.id = 'new-' + fileIndex;
                                div.dataset.fileIndex = fileIndex;

                                let previewHtml = '';
                                if (isImage) {
                                    const reader = new FileReader();
                                    reader.onload = function (event) {
                                        const imgElement = div.querySelector('img');
                                        if (imgElement) imgElement.src = event.target.result;
                                    };
                                    reader.readAsDataURL(file);
                                    previewHtml = `<img src="" class="w-100 h-100 object-fit-cover" alt="New Image">`;
                                } else {
                                    const fileURL = URL.createObjectURL(file);
                                    previewHtml = `<video src="${fileURL}" class="w-100 h-100 object-fit-cover bg-black" controls muted></video>`;
                                }

                                div.innerHTML = `
                                    <div class="border rounded p-1 position-relative" style="width: 150px; height: 150px;">
                                        ${previewHtml}
                                        ${isVideo ? '<div class="position-absolute top-0 start-0 m-1"><span class="badge bg-dark opacity-75"><i class="fas fa-video"></i></span></div>' : ''}
                                    </div>
                                    <button type="button" class="btn btn-danger btn-sm remove-new-image-btn" style="width: 150px;">
                                        Remove
                                    </button>
                                `;
                                gallery.appendChild(div);
                                updateOrder();
                            });
                            hiddenInput.value = '';
                        });

                        // Remove new image preview
                        gallery.addEventListener('click', function (e) {
                            if (e.target.classList.contains('remove-new-image-btn')) {
                                const container = e.target.closest('.image-container');
                                const fileIndex = parseInt(container.dataset.fileIndex);
                                selectedFiles[fileIndex] = null;
                                container.remove();
                                updateOrder();
                            }
                        });

                        // Remove unused container
                        const oldContainer = document.getElementById('new-images-container');
                        if (oldContainer) oldContainer.remove();

                        // Before form submit, update the file input with selected files in visual order
                        const form = document.querySelector('.story-form');
                        form.addEventListener('submit', function () {
                            updateOrder();
                            const dt = new DataTransfer();
                            const newContainers = Array.from(gallery.querySelectorAll('.new-media'));
                            newContainers.forEach(container => {
                                const index = parseInt(container.dataset.fileIndex);
                                if (selectedFiles[index]) {
                                    dt.items.add(selectedFiles[index]);
                                }
                            });
                            hiddenInput.files = dt.files;
                        });

                        // Delete confirmation / AJAX
                        const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
                        let pendingDeleteAction = null;

                        confirmDeleteBtn.addEventListener('click', function () {
                            if (pendingDeleteAction) {
                                pendingDeleteAction();
                                pendingDeleteAction = null;
                            }
                            deleteModal.hide();
                        });

                        gallery.addEventListener('click', function (e) {
                            const btn = e.target.closest('.delete-image-btn, .delete-main-image-btn');
                            if (!btn) return;

                            e.preventDefault();
                            const url = btn.dataset.url;
                            const container = btn.closest('.image-container');

                            pendingDeleteAction = function () {
                                fetch(url, {
                                    method: 'POST',
                                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            container.remove();
                                            updateOrder();
                                        } else {
                                            alert('Failed: ' + (data.error || 'Unknown error'));
                                        }
                                    })
                                    .catch(err => alert('Error deleting.'));
                            };
                            deleteModal.show();
                        });
                    });
                </script>
                <script src="{{ url_for('static', filename='js/speech.js') }}"></script>

                <div class="mb-3">
                    <label for="location" class="form-label fw-bold fs-5">{{ _('Location (Singapore)') }}</label>
                    <div class="input-group">
                        <input type="text" id="location" name="location" list="singapore-locations"
                            class="form-control form-control-lg" maxlength="100" value="{{ story['location'] }}"
                            placeholder="e.g. Toa Payoh Public Library">
                        <button type="button" id="use-location-btn" class="btn btn-outline-secondary"
                            onclick="populateLocationField('location', 'use-location-btn')">
                            <i class="fas fa-crosshairs"></i> {{ _('Use My Location') }}
                        </button>
                    </div>
                    {% include 'partials/locations.html' %}
                </div>
                <script src="{{ url_for('static', filename='js/geolocation.js') }}"></script>

                <!-- Tags Input -->
                <div class="mb-3">
                    <label for="tags" class="form-label fw-bold fs-5">{{ _('Tags') }}</label>
                    <input type="text" id="tags" name="tags" class="form-control form-control-lg" maxlength="200"
                        value="{{ story_tags }}" placeholder="e.g. Food, Heritage, Nature (comma-separated, max 5)">
                    <div class="form-text">{{ _('Add up to 5 tags to help others find your story. Separate with
                        commas.') }}</div>
                </div>

                <div class="d-flex gap-2 justify-content-end">
                    <a href="{{ url_for('stories.view_story', story_id=story['id']) }}"
                        class="btn btn-lg btn-outline-secondary">{{ _('Cancel') }}</a>
                    <button type="submit" class="btn btn-lg btn-primary">{{ _('Update Story') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Validation Modal -->
<div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold text-dark fs-4" id="validationModalLabel">Missing Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-secondary fs-5 py-3">
                <p class="mb-2">Please fix the following issues:</p>
                <ul id="validation-errors" class="text-danger mb-0"></ul>
            </div>
            <div class="modal-footer border-top-0 pt-0 pb-4 justify-content-center">
                <button type="button" class="btn btn-primary px-5 fw-bold" data-bs-dismiss="modal">Okay</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold text-dark fs-4" id="deleteConfirmModalLabel">{{ _('Delete Image') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-secondary fs-5 py-3">
                <p class="mb-0">{{ _('Are you sure you want to delete this image? This action cannot be undone.') }}</p>
            </div>
            <div class="modal-footer border-top-0 pt-0 pb-4 justify-content-center gap-2">
                <button type="button" class="btn btn-secondary px-4 fw-bold" data-bs-dismiss="modal">{{ _('Cancel')
                    }}</button>
                <button type="button" class="btn btn-danger px-4 fw-bold" id="confirmDeleteBtn">{{ _('Delete')
                    }}</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('.story-form');

        form.addEventListener('submit', function (e) {
            const errors = [];
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();

            if (!title) {
                errors.push('Title is required.');
            } else if (title.length < 3) {
                errors.push('Title must be at least 3 characters.');
            } else if (title.length > 100) {
                errors.push('Title cannot exceed 100 characters.');
            }

            if (!content) {
                errors.push('Story content is required.');
            } else if (content.length < 10) {
                errors.push('Story content must be at least 10 characters.');
            }

            if (errors.length > 0) {
                e.preventDefault();
                const errorList = document.getElementById('validation-errors');
                errorList.innerHTML = errors.map(err => `<li>${err}</li>`).join('');
                const modal = new bootstrap.Modal(document.getElementById('validationModal'));
                modal.show();
            }
        });
    });
</script>
{% endblock %}