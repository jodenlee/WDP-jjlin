{% extends 'base.html' %}

{% block content %}
<section class="mb-5">
    <div class="d-flex flex-column gap-3">
        <div class="d-flex align-items-center position-relative">
            <a href="{{ url_for('stories.stories_list') }}" class="btn btn-primary btn-lg me-3">‚Üê Back</a>
            <h1 class="fw-bold mb-0">My Favourites</h1>
        </div>

        <!-- Search & Filters -->
        <div class="card border-0 shadow-sm p-3 bg-light">
            <form action="{{ url_for('stories.my_bookmarks') }}" method="get" class="row g-2 align-items-center"
                id="fav-search-form">
                <!-- Search -->
                <div class="col-12 col-md-5 position-relative">
                    <input type="text" name="search" id="fav-search-input" class="form-control form-control-lg pe-5"
                        placeholder="Search your favourites..." value="{{ request.args.get('search', '') }}">
                    <i class="fas fa-times position-absolute top-50 end-0 translate-middle-y me-4 text-muted cursor-pointer"
                        id="fav-clear-search" style="cursor: pointer; display: none;"></i>
                </div>

                <!-- Tags Filter (Custom Dropdown) -->
                <div class="col-4 col-md-2 position-relative">
                    <div class="dropdown">
                        <button class="form-select form-select-lg w-100 text-start" type="button" id="favTagsDropdown"
                            data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                            <span class="fav-tags-display text-truncate d-block">{% if selected_tags %}{{ selected_tags
                                |
                                join(', ') }}{% else %}Tags{% endif %}</span>
                        </button>
                        <ul class="dropdown-menu p-2" style="min-width: 200px; max-height: 400px; overflow-y: auto;"
                            aria-labelledby="favTagsDropdown">
                            {% for tag in all_tags %}
                            <li>
                                <label class="dropdown-item d-flex align-items-center gap-2 py-2">
                                    <input type="checkbox" name="tags" value="{{ tag }}" class="form-check-input m-0" {%
                                        if tag in selected_tags %}checked{% endif %} onchange="updateFavTagsDisplay()">
                                    <span>{{ tag }}</span>
                                </label>
                            </li>
                            {% else %}
                            <li class="dropdown-item text-muted">No tags available</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <!-- Sorting -->
                <div class="col-4 col-md-2">
                    <select name="sort" class="form-select form-select-lg">
                        <option value="newest" {% if request.args.get('sort')=='newest' %}selected{% endif %}>Newest
                        </option>
                        <option value="likes" {% if request.args.get('sort')=='likes' %}selected{% endif %}>Popular
                        </option>
                    </select>
                </div>

                <!-- Location -->
                <div class="col-4 col-md-2">
                    <div class="input-group">
                        <input type="text" id="fav-location-filter" name="location" list="singapore-locations"
                            class="form-control form-control-lg" placeholder="Location"
                            value="{{ request.args.get('location', '') }}">
                        <!-- Clear Location Button -->
                        <button type="button" class="btn btn-outline-secondary border-start-0 border"
                            id="fav-clear-location" style="display: none;" title="Clear Location">
                            <i class="fas fa-times"></i>
                        </button>
                        <button type="button" id="fav-use-location-btn" class="btn btn-outline-secondary"
                            onclick="populateLocationField('fav-location-filter', 'fav-use-location-btn')"
                            title="Use My Location">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                    </div>
                    {% include 'partials/locations.html' %}
                </div>

                <!-- Search Button -->
                <div class="col-12 col-md-1 d-grid">
                    <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-search"></i></button>
                </div>
            </form>
            <script src="{{ url_for('static', filename='js/geolocation.js') }}"></script>
            <script>
                function updateFavTagsDisplay() {
                    const checkboxes = document.querySelectorAll('#favTagsDropdown + .dropdown-menu input[type="checkbox"]:checked');
                    const display = document.querySelector('.fav-tags-display');
                    if (checkboxes.length === 0) {
                        display.textContent = 'Tags';
                    } else {
                        const tags = Array.from(checkboxes).map(cb => cb.value);
                        display.textContent = tags.join(', ');
                    }
                }
            </script>
        </div>
    </div>
</section>

<!-- Stories Grid Container -->
<div id="fav-stories-grid-container">
    {% include 'stories/_favourites_grid.html' %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('fav-search-input');
        const clearSearchBtn = document.getElementById('fav-clear-search');

        const locationInput = document.getElementById('fav-location-filter');
        const clearLocationBtn = document.getElementById('fav-clear-location');

        const sortSelect = document.querySelector('select[name="sort"]');
        const tagsInputs = document.querySelectorAll('input[name="tags"]');
        const gridContainer = document.getElementById('fav-stories-grid-container');
        const searchForm = document.getElementById('fav-search-form');

        let debounceTimer;

        // Helper: Toggle clear buttons
        function toggleClearButton(input, button) {
            button.style.display = input.value.trim() !== '' ? 'block' : 'none';
            // For location input group, managing border might be needed or just keep it simple
        }

        // Initial check
        if (searchInput) toggleClearButton(searchInput, clearSearchBtn);
        if (locationInput) toggleClearButton(locationInput, clearLocationBtn);

        function fetchStories() {
            gridContainer.style.opacity = '0.5';

            const formData = new FormData(searchForm);
            const params = new URLSearchParams(formData);
            let fetchUrl = "{{ url_for('stories.my_bookmarks') }}?" + params.toString() + "&ajax=1";

            fetch(fetchUrl, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(response => response.text())
                .then(html => {
                    gridContainer.innerHTML = html;
                    gridContainer.style.opacity = '1';
                })
                .catch(error => {
                    console.error('Error fetching favorites:', error);
                    gridContainer.style.opacity = '1';
                });
        }

        function debounce(func, delay) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(func, delay);
        }

        // Search Input Logic
        if (searchInput) {
            searchInput.addEventListener('input', () => {
                toggleClearButton(searchInput, clearSearchBtn);
                debounce(() => fetchStories(), 500);
            });

            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                toggleClearButton(searchInput, clearSearchBtn);
                fetchStories();
                searchInput.focus();
            });
        }

        // Location Input Logic
        if (locationInput) {
            locationInput.addEventListener('input', () => {
                toggleClearButton(locationInput, clearLocationBtn);
                debounce(() => fetchStories(), 500);
            });

            clearLocationBtn.addEventListener('click', () => {
                locationInput.value = '';
                toggleClearButton(locationInput, clearLocationBtn);
                fetchStories();
                locationInput.focus();
            });
        }

        if (sortSelect) sortSelect.addEventListener('change', () => fetchStories());

        tagsInputs.forEach(input => {
            input.addEventListener('change', () => {
                updateFavTagsDisplay();
                fetchStories();
            });
        });

        searchForm.addEventListener('submit', function (e) {
            e.preventDefault();
            fetchStories();
        });
    });
</script>
{% endblock %}