{% extends 'base.html' %}

{% block content %}
<section class="mb-5">
    <!-- Header Actions -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
        <h1 class="fw-bold text-dark mb-3 mb-md-0">Stories Feed</h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('stories.my_bookmarks') }}" class="btn btn-warning btn-lg">My Favourites</a>
            <a href="{{ url_for('stories.create_story') }}" class="btn btn-primary btn-lg">Post Story</a>
        </div>
    </div>
    {% if request.args.get('search') or request.args.get('location') or request.args.get('tags') %}
    <div class="mb-4">
        <a href="{{ url_for('stories.stories_list') }}" class="btn btn-primary btn-lg fs-4">
            <i class="fas fa-arrow-left me-2"></i>Back to All Stories
        </a>
    </div>
    {% endif %}

    <!-- Search & Filters -->
    <div class="card border-0 shadow-sm p-3 mb-4 bg-light">
        <form action="{{ url_for('stories.stories_list') }}" method="get" class="row g-2 align-items-center"
            id="search-form">
            <!-- Search -->
            <div class="col-12 col-md-5 position-relative">
                <input type="text" name="search" id="search-input" class="form-control form-control-lg pe-5"
                    placeholder="Search stories..." value="{{ request.args.get('search', '') }}">
                <i class="fas fa-times position-absolute top-50 end-0 translate-middle-y me-4 text-muted cursor-pointer"
                    id="clear-search" style="cursor: pointer; display: none;"></i>
            </div>

            <!-- Tags Filter (Custom Dropdown) -->
            <div class="col-4 col-md-2 position-relative">
                <div class="dropdown">
                    <button class="form-select form-select-lg w-100 text-start" type="button" id="tagsDropdown"
                        data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                        <span class="tags-display text-truncate d-block">{% if selected_tags %}{{ selected_tags |
                            join(', ')
                            }}{% else %}Tags{% endif %}</span>
                    </button>
                    <ul class="dropdown-menu p-2" style="min-width: 200px; max-height: 400px; overflow-y: auto;"
                        aria-labelledby="tagsDropdown">
                        {% for tag in all_tags %}
                        <li>
                            <label class="dropdown-item d-flex align-items-center gap-2 py-2">
                                <input type="checkbox" name="tags" value="{{ tag }}" class="form-check-input m-0" {% if
                                    tag in selected_tags %}checked{% endif %} onchange="updateTagsDisplay()">
                                <span>{{ tag }}</span>
                            </label>
                        </li>
                        {% else %}
                        <li class="dropdown-item text-muted">No tags available</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- Sorting -->
            <div class="col-4 col-md-2">
                <select name="sort" class="form-select form-select-lg">
                    <option value="newest" {% if request.args.get('sort')=='newest' %}selected{% endif %}>Newest
                    </option>
                    <option value="likes" {% if request.args.get('sort')=='likes' %}selected{% endif %}>Popular</option>
                </select>
            </div>

            <!-- Location -->
            <div class="col-4 col-md-2">
                <div class="input-group">
                    <input type="text" id="location-filter" name="location" list="singapore-locations"
                        class="form-control form-control-lg" placeholder="Location"
                        value="{{ request.args.get('location', '') }}">
                    <!-- Clear Location Button -->
                    <button type="button" class="btn btn-outline-secondary border-start-0 border" id="clear-location"
                        style="display: none;" title="Clear Location">
                        <i class="fas fa-times"></i>
                    </button>
                    <button type="button" id="use-location-btn" class="btn btn-outline-secondary"
                        onclick="populateLocationField('location-filter', 'use-location-btn')" title="Use My Location">
                        <i class="fas fa-crosshairs"></i>
                    </button>
                </div>
                {% include 'partials/locations.html' %}
            </div>

            <!-- Search Button -->
            <div class="col-12 col-md-1 d-grid">
                <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-search"></i></button>
            </div>
        </form>
        <script src="{{ url_for('static', filename='js/geolocation.js') }}"></script>
        <script>
            function updateTagsDisplay() {
                const checkboxes = document.querySelectorAll('#tagsDropdown + .dropdown-menu input[type="checkbox"]:checked');
                const display = document.querySelector('.tags-display');
                if (checkboxes.length === 0) {
                    display.textContent = 'Tags';
                } else {
                    const tags = Array.from(checkboxes).map(cb => cb.value);
                    display.textContent = tags.join(', ');
                }
            }
        </script>
    </div>
</section>

<!-- Stories Grid Container -->
<div id="stories-grid-container">
    {% include 'stories/_stories_grid.html' %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('search-input');
        const clearSearchBtn = document.getElementById('clear-search');

        const locationInput = document.getElementById('location-filter');
        const clearLocationBtn = document.getElementById('clear-location');

        const sortSelect = document.querySelector('select[name="sort"]');
        const tagsInputs = document.querySelectorAll('input[name="tags"]');
        const tagsDisplay = document.querySelector('.tags-display');
        const gridContainer = document.getElementById('stories-grid-container');
        const searchForm = document.getElementById('search-form');

        let debounceTimer;

        // Helper: Toggle clear buttons
        function toggleClearButton(input, button) {
            button.style.display = input.value.trim() !== '' ? 'block' : 'none';
            // For location input group, managing border might be needed or just keep it simple
        }

        // Initial check
        if (searchInput) toggleClearButton(searchInput, clearSearchBtn);
        if (locationInput) toggleClearButton(locationInput, clearLocationBtn);

        function fetchStories(url = null) {
            // Show loading state (optional: add a spinner or opacity change)
            gridContainer.style.opacity = '0.5';

            const formData = new FormData(searchForm);
            const params = new URLSearchParams(formData);

            // If a specific URL is provided (pagination), use it but ensure params are included if needed
            let fetchUrl = url;
            if (!fetchUrl) {
                fetchUrl = "{{ url_for('stories.stories_list') }}?" + params.toString();
            } else {
                // For pagination links that already have params, we might just fetch them directly
                // But we need to ensure we add the ajax flag
                if (fetchUrl.includes('?')) {
                    fetchUrl += '&ajax=1';
                } else {
                    fetchUrl += '?ajax=1';
                }
            }

            // Ensure ajax param is always present
            if (!fetchUrl.includes('ajax=1')) {
                if (fetchUrl.includes('?')) {
                    fetchUrl += '&ajax=1';
                } else {
                    fetchUrl += '?ajax=1';
                }
            }

            fetch(fetchUrl, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.text())
                .then(html => {
                    gridContainer.innerHTML = html;
                    gridContainer.style.opacity = '1';

                    // Re-bind pagination links to use AJAX
                    bindPaginationLinks();

                    // Update URL without reloading (optional, good for shareability)
                    // history.pushState({}, '', fetchUrl.replace('&ajax=1', '').replace('?ajax=1', ''));
                })
                .catch(error => {
                    console.error('Error fetching stories:', error);
                    gridContainer.style.opacity = '1';
                });
        }

        function bindPaginationLinks() {
            const paginationLinks = gridContainer.querySelectorAll('.pagination a, .btn-group a, .d-flex a.btn');
            paginationLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    fetchStories(this.href);
                });
            });
        }

        // Debounce function
        function debounce(func, delay) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(func, delay);
        }

        // Search Input Logic
        if (searchInput) {
            searchInput.addEventListener('input', () => {
                toggleClearButton(searchInput, clearSearchBtn);
                debounce(() => fetchStories(), 500);
            });

            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                toggleClearButton(searchInput, clearSearchBtn);
                fetchStories();
                searchInput.focus();
            });
        }

        // Location Input Logic
        if (locationInput) {
            locationInput.addEventListener('input', () => {
                toggleClearButton(locationInput, clearLocationBtn);
                debounce(() => fetchStories(), 500);
            });

            clearLocationBtn.addEventListener('click', () => {
                locationInput.value = '';
                toggleClearButton(locationInput, clearLocationBtn);
                fetchStories();
                locationInput.focus();
            });
        }

        if (sortSelect) {
            sortSelect.addEventListener('change', () => fetchStories());
        }

        tagsInputs.forEach(input => {
            input.addEventListener('change', () => {
                updateTagsDisplay(); // existing function
                fetchStories();
            });
        });

        // Prevent default form submission and use AJAX
        searchForm.addEventListener('submit', function (e) {
            e.preventDefault();
            fetchStories();
        });

        // Initial binding
        bindPaginationLinks();
    });
</script>
{% endblock %}